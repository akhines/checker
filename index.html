<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MD Homeowner Verification</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #0d1117; color: #e6edf3; font-family: Georgia, serif; min-height: 100vh; padding: 2rem 1rem; }
  .wrap { max-width: 700px; margin: 0 auto; }

  /* Header */
  .eyebrow { display: flex; align-items: center; gap: 8px; font-family: monospace; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.12em; color: #3fb950; margin-bottom: 0.5rem; }
  .dot { width: 8px; height: 8px; border-radius: 50%; background: #238636; flex-shrink: 0; }
  h1 { font-size: 1.9rem; font-weight: 700; color: #fff; margin-bottom: 0.25rem; }
  .subtitle { color: #8b949e; font-size: 0.9rem; font-style: italic; margin-bottom: 2rem; }

  /* Cards */
  .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.25rem; }
  .card-success { background: #161b22; border: 1px solid #238636; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.25rem; }
  .card-title { font-family: monospace; font-size: 0.85rem; color: #58a6ff; border-bottom: 1px solid #21262d; padding-bottom: 0.6rem; margin-bottom: 1.25rem; }
  .card-title-green { font-family: monospace; font-size: 0.85rem; color: #3fb950; border-bottom: 1px solid #21262d; padding-bottom: 0.6rem; margin-bottom: 1.25rem; }

  /* Drop zone */
  .dropzone { border: 2px dashed #30363d; border-radius: 8px; padding: 2.5rem; text-align: center; cursor: pointer; transition: border-color 0.2s, background 0.2s; }
  .dropzone:hover, .dropzone.active { border-color: #58a6ff; background: rgba(88,166,255,0.04); }
  .dropzone-icon { font-size: 2.2rem; margin-bottom: 0.5rem; }
  .dropzone-text { color: #8b949e; font-size: 0.9rem; }
  .badge { display: inline-block; background: #1a3d22; color: #3fb950; border-radius: 20px; padding: 0.2rem 0.75rem; font-family: monospace; font-size: 0.75rem; font-weight: 600; margin-top: 0.4rem; }

  /* Form */
  .field { margin-bottom: 1rem; }
  .field label { display: block; font-family: monospace; font-size: 0.69rem; text-transform: uppercase; letter-spacing: 0.1em; color: #8b949e; margin-bottom: 0.3rem; }
  .field .hint { font-family: monospace; font-size: 0.71rem; color: #6e7681; margin-top: 0.2rem; }
  select { width: 100%; background: #0d1117; border: 1px solid #30363d; color: #e6edf3; border-radius: 4px; padding: 0.45rem 0.7rem; font-size: 0.85rem; font-family: monospace; outline: none; }
  select:focus { border-color: #58a6ff; }
  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

  /* Buttons */
  .btn-run { background: #238636; color: #fff; border: none; border-radius: 6px; padding: 0.6rem 1.4rem; font-family: monospace; font-size: 0.85rem; font-weight: 700; cursor: pointer; transition: background 0.15s; }
  .btn-run:hover:not(:disabled) { background: #2ea043; }
  .btn-run:disabled { background: #1a3d22; color: #4d7a55; cursor: not-allowed; }
  .btn-stop { background: #da3633; color: #fff; border: none; border-radius: 6px; padding: 0.45rem 0.9rem; font-family: monospace; font-size: 0.78rem; cursor: pointer; }
  .btn-stop:hover { background: #f85149; }
  .btn-dl { background: #1f6feb; color: #fff; border: none; border-radius: 6px; padding: 0.6rem 1.4rem; font-family: monospace; font-size: 0.85rem; font-weight: 700; cursor: pointer; }
  .btn-dl:hover { background: #388bfd; }
  .btn-row { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }

  /* Progress */
  .prog-wrap { margin-top: 0.75rem; background: #21262d; border-radius: 3px; height: 5px; overflow: hidden; }
  .prog-fill { height: 100%; background: linear-gradient(90deg, #238636, #2ea043); border-radius: 3px; transition: width 0.3s; }
  .prog-text { font-family: monospace; font-size: 0.82rem; color: #8b949e; }
  .match-text { color: #3fb950; }

  /* Log */
  .log { background: #0d1117; border: 1px solid #21262d; border-radius: 4px; padding: 0.6rem 0.75rem; max-height: 130px; overflow-y: auto; font-family: monospace; font-size: 0.72rem; color: #8b949e; margin-top: 0.75rem; }

  /* Stats */
  .stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 1.25rem; }
  .stat-label { font-family: monospace; font-size: 0.69rem; text-transform: uppercase; letter-spacing: 0.1em; color: #8b949e; margin-bottom: 0.2rem; }
  .stat-value { font-size: 2rem; font-weight: 700; }
  .stat-value.green { color: #3fb950; }
  .code-tag { background: #21262d; color: #8b949e; border-radius: 3px; padding: 0.1rem 0.4rem; font-family: monospace; font-size: 0.72rem; }

  /* Footer */
  .footer { text-align: center; font-family: monospace; font-size: 0.7rem; color: #4d7a55; margin-top: 2rem; }

  .hidden { display: none; }
</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="eyebrow"><span class="dot"></span>Maryland SDAT ¬∑ Public Records</div>
  <h1>Homeowner Verification</h1>
  <p class="subtitle">Cross-reference your prospect list against Maryland property records</p>

  <!-- Step 1: Upload -->
  <div class="card">
    <div class="card-title">‚ë† Upload Your CSV</div>
    <div class="dropzone" id="dropzone">
      <input type="file" accept=".csv" id="fileInput" class="hidden"/>
      <div id="dropEmpty">
        <div class="dropzone-icon">‚¨ÜÔ∏è</div>
        <div class="dropzone-text">Drop your CSV here, or click to browse</div>
      </div>
      <div id="dropLoaded" class="hidden">
        <div style="font-family:monospace;margin-bottom:0.4rem" id="fileName"></div>
        <span class="badge" id="recordCount"></span>
      </div>
    </div>
  </div>

  <!-- Step 2: Column Mapping -->
  <div class="card hidden" id="mappingCard">
    <div class="card-title">‚ë° Map Your Columns</div>
    <div class="field">
      <label>Decedent / Owner Name *</label>
      <select id="colName"></select>
      <div class="hint">The name to match against SDAT owner records</div>
    </div>
    <div class="grid2">
      <div class="field">
        <label>Property Address *</label>
        <select id="colAddr"></select>
        <div class="hint">e.g. "123 Main St"</div>
      </div>
      <div class="field">
        <label>City</label>
        <select id="colCity"></select>
        <div class="hint">Improves accuracy</div>
      </div>
    </div>
    <div class="field" style="max-width:320px">
      <label>ZIP Code</label>
      <select id="colZip"></select>
      <div class="hint">Strongly recommended</div>
    </div>
  </div>

  <!-- Step 3: Run -->
  <div class="card hidden" id="runCard">
    <div class="card-title">‚ë¢ Verify Against SDAT</div>
    <div class="btn-row">
      <button class="btn-run" id="btnRun">‚ñ∂&nbsp; Run Verification</button>
      <button class="btn-stop hidden" id="btnStop">Stop</button>
      <span class="prog-text hidden" id="progText"></span>
    </div>
    <div class="prog-wrap hidden" id="progWrap">
      <div class="prog-fill" id="progFill" style="width:0%"></div>
    </div>
    <div class="log hidden" id="logBox"></div>
  </div>

  <!-- Results -->
  <div class="card-success hidden" id="resultsCard">
    <div class="card-title-green">‚úì Verification Complete</div>
    <div class="stats">
      <div><div class="stat-label">Total Checked</div><div class="stat-value" id="statTotal">0</div></div>
      <div><div class="stat-label">Verified Matches</div><div class="stat-value green" id="statMatches">0</div></div>
      <div><div class="stat-label">Match Rate</div><div class="stat-value" id="statRate">0%</div></div>
    </div>
    <button class="btn-dl" id="btnDownload">‚¨á&nbsp; Download Verified Matches CSV</button>
    <div style="margin-top:0.75rem;font-family:monospace;font-size:0.72rem;color:#6e7681">
      Adds columns: <span class="code-tag">_Verified_Owner</span> <span class="code-tag">_Verified_Address</span> <span class="code-tag">_Status</span>
    </div>
  </div>

  <div class="footer">Data sourced from Maryland Open Data ¬∑ SDAT Real Property Assessments ¬∑ Updated Tue‚ÄìSat</div>
</div>

<script>
const ENDPOINT = "https://opendata.maryland.gov/resource/x8a5-h2sy.json";
let csvData = null;
let resultCSV = "";
let aborted = false;

// --- CSV Parser ---
function parseCSV(text) {
  const lines = text.trim().split("\n");
  if (lines.length < 2) return { headers: [], rows: [] };
  function splitRow(line) {
    const out = []; let cur = "", q = false;
    for (const ch of line) {
      if (ch === '"') { q = !q; continue; }
      if (ch === ',' && !q) { out.push(cur.trim()); cur = ""; continue; }
      cur += ch;
    }
    out.push(cur.trim());
    return out;
  }
  const headers = splitRow(lines[0]);
  const rows = lines.slice(1).filter(l => l.trim()).map(l => {
    const v = splitRow(l);
    return Object.fromEntries(headers.map((h, i) => [h, v[i] || ""]));
  });
  return { headers, rows };
}

function toCSVLine(headers, row) {
  return headers.map(h => '"' + (row[h] || "").replace(/"/g, '""') + '"').join(",");
}

// --- Auto detect columns ---
function autoDetect(headers) {
  const h = headers.map(x => x.toLowerCase());
  const find = (...words) => {
    const idx = h.findIndex(c => words.some(w => c.includes(w)));
    return idx >= 0 ? headers[idx] : "";
  };
  return {
    name: find("decedent","deceased","name","owner"),
    addr: find("address","street","property"),
    city: find("city"),
    zip:  find("zip","postal"),
  };
}

// --- Populate selects ---
function populateSelect(id, headers, selected, addBlank) {
  const el = document.getElementById(id);
  el.innerHTML = "";
  if (addBlank) {
    const o = document.createElement("option");
    o.value = ""; o.textContent = "‚Äî optional ‚Äî";
    el.appendChild(o);
  }
  headers.forEach(h => {
    const o = document.createElement("option");
    o.value = h; o.textContent = h;
    if (h === selected) o.selected = true;
    el.appendChild(o);
  });
}

// --- Fuzzy name match ---
function fuzzyMatch(decedent, owner) {
  if (!decedent || !owner) return false;
  const norm = s => s.toUpperCase().replace(/[^A-Z\s]/g, "").trim();
  const tokens = norm(decedent).split(/\s+/).filter(t => t.length > 1);
  const ownerNorm = norm(owner);
  return tokens.every(t => ownerNorm.includes(t));
}

// --- SDAT Lookup ---
async function lookup(address, city, zip) {
  const m = address.trim().match(/^(\d+)\s+(.+?)(?:,.*)?$/);
  if (!m && !zip) return null;
  const conditions = [];
  if (m) {
    conditions.push("premise_address_number='" + m[1] + "'");
    conditions.push("upper(premise_street_name) like '%" + encodeURIComponent(m[2].toUpperCase().split(" ")[0]) + "%'");
  }
  if (city) conditions.push("upper(premise_city) like '%" + encodeURIComponent(city.toUpperCase()) + "%'");
  if (zip) conditions.push("premise_zip_code='" + zip.replace(/\D/g,"").slice(0,5) + "'");
  try {
    const r = await fetch(ENDPOINT + "?$limit=5&$where=" + conditions.join(" AND "));
    if (!r.ok) return null;
    const d = await r.json();
    return d.length ? d : null;
  } catch { return null; }
}

// --- File loading ---
function loadFile(file) {
  if (!file || !file.name.endsWith(".csv")) return;
  const reader = new FileReader();
  reader.onload = e => {
    csvData = parseCSV(e.target.result);
    document.getElementById("fileName").textContent = "üìÑ " + file.name;
    document.getElementById("recordCount").textContent = csvData.rows.length.toLocaleString() + " records loaded";
    document.getElementById("dropEmpty").classList.add("hidden");
    document.getElementById("dropLoaded").classList.remove("hidden");

    const d = autoDetect(csvData.headers);
    populateSelect("colName", csvData.headers, d.name, false);
    populateSelect("colAddr", csvData.headers, d.addr, true);
    populateSelect("colCity", csvData.headers, d.city, true);
    populateSelect("colZip",  csvData.headers, d.zip,  true);

    document.getElementById("mappingCard").classList.remove("hidden");
    document.getElementById("runCard").classList.remove("hidden");
    document.getElementById("resultsCard").classList.add("hidden");
    document.getElementById("logBox").innerHTML = "";
    document.getElementById("logBox").classList.add("hidden");
  };
  reader.readAsText(file);
}

// --- Drop zone ---
const dz = document.getElementById("dropzone");
dz.addEventListener("click", () => document.getElementById("fileInput").click());
dz.addEventListener("dragover", e => { e.preventDefault(); dz.classList.add("active"); });
dz.addEventListener("dragleave", () => dz.classList.remove("active"));
dz.addEventListener("drop", e => { e.preventDefault(); dz.classList.remove("active"); loadFile(e.dataTransfer.files[0]); });
document.getElementById("fileInput").addEventListener("change", e => loadFile(e.target.files[0]));

// --- Run ---
document.getElementById("btnRun").addEventListener("click", async () => {
  if (!csvData) return;
  const nameCol = document.getElementById("colName").value;
  const addrCol = document.getElementById("colAddr").value;
  const cityCol = document.getElementById("colCity").value;
  const zipCol  = document.getElementById("colZip").value;
  if (!nameCol) return;

  aborted = false;
  const btnRun  = document.getElementById("btnRun");
  const btnStop = document.getElementById("btnStop");
  const progWrap = document.getElementById("progWrap");
  const progFill = document.getElementById("progFill");
  const progText = document.getElementById("progText");
  const logBox   = document.getElementById("logBox");
  const resultsCard = document.getElementById("resultsCard");

  btnRun.disabled = true;
  btnStop.classList.remove("hidden");
  progWrap.classList.remove("hidden");
  progText.classList.remove("hidden");
  logBox.innerHTML = "";
  logBox.classList.remove("hidden");
  resultsCard.classList.add("hidden");

  const matches = [];
  const total = csvData.rows.length;

  for (let i = 0; i < total; i++) {
    if (aborted) break;
    const row = csvData.rows[i];
    const name = row[nameCol] || "";
    const records = await lookup(row[addrCol]||"", row[cityCol]||"", row[zipCol]||"");

    let matched = false, verifiedOwner = "", verifiedAddr = "";
    if (records) {
      for (const rec of records) {
        const o1 = rec.owner_name_1 || "", o2 = rec.owner_name_2 || "";
        if (fuzzyMatch(name, o1) || fuzzyMatch(name, o2)) {
          matched = true;
          verifiedOwner = [o1, o2].filter(Boolean).join(" / ");
          verifiedAddr = (rec.premise_address_number||"") + " " + (rec.premise_street_name||"") + ", " + (rec.premise_city||"") + " " + (rec.premise_zip_code||"");
          break;
        }
      }
      if (!matched) {
        const line = document.createElement("div");
        line.textContent = 'Row ' + (i+1) + ': "' + name + '" ‚Äî address found, owner mismatch (SDAT: ' + (records[0].owner_name_1||"?") + ')';
        logBox.appendChild(line);
        logBox.scrollTop = logBox.scrollHeight;
      }
    } else {
      const line = document.createElement("div");
      line.textContent = 'Row ' + (i+1) + ': "' + name + '" ‚Äî no record found';
      logBox.appendChild(line);
      logBox.scrollTop = logBox.scrollHeight;
    }

    if (matched) matches.push({ ...row, _Verified_Owner: verifiedOwner, _Verified_Address: verifiedAddr.trim(), _Status: "MATCH" });

    const pct = Math.round(((i+1)/total)*100);
    progFill.style.width = pct + "%";
    progText.innerHTML = pct + "% &nbsp;¬∑&nbsp; <span style='color:#3fb950'>" + matches.length + " matches</span>";

    await new Promise(r => setTimeout(r, 120));
  }

  // Build output CSV
  const outHeaders = [...csvData.headers, "_Verified_Owner", "_Verified_Address", "_Status"];
  const lines = [outHeaders.join(","), ...matches.map(r => toCSVLine(outHeaders, r))];
  resultCSV = lines.join("\n");

  document.getElementById("statTotal").textContent = Math.min(total, csvData.rows.length).toLocaleString();
  document.getElementById("statMatches").textContent = matches.length.toLocaleString();
  document.getElementById("statRate").textContent = total ? Math.round((matches.length/total)*100) + "%" : "0%";

  btnRun.disabled = false;
  btnRun.textContent = "‚ñ∂  Run Verification";
  btnStop.classList.add("hidden");
  resultsCard.classList.remove("hidden");
});

document.getElementById("btnStop").addEventListener("click", () => { aborted = true; });

document.getElementById("btnDownload").addEventListener("click", () => {
  const blob = new Blob([resultCSV], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "verified_matches_" + new Date().toISOString().slice(0,10) + ".csv";
  a.click();
});
</script>
</body>
</html>
