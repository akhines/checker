<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MD Homeowner Verification</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #0d1117; color: #e6edf3; font-family: Georgia, serif; min-height: 100vh; padding: 2rem 1rem; }
  .wrap { max-width: 700px; margin: 0 auto; }
  .eyebrow { display: flex; align-items: center; gap: 8px; font-family: monospace; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.12em; color: #3fb950; margin-bottom: 0.5rem; }
  .dot { width: 8px; height: 8px; border-radius: 50%; background: #238636; flex-shrink: 0; }
  h1 { font-size: 1.9rem; font-weight: 700; color: #fff; margin-bottom: 0.25rem; }
  .subtitle { color: #8b949e; font-size: 0.9rem; font-style: italic; margin-bottom: 2rem; }
  .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.25rem; }
  .card-success { background: #161b22; border: 1px solid #238636; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.25rem; }
  .card-title { font-family: monospace; font-size: 0.85rem; color: #58a6ff; border-bottom: 1px solid #21262d; padding-bottom: 0.6rem; margin-bottom: 1.25rem; }
  .card-title-green { font-family: monospace; font-size: 0.85rem; color: #3fb950; border-bottom: 1px solid #21262d; padding-bottom: 0.6rem; margin-bottom: 1.25rem; }
  .dropzone { border: 2px dashed #30363d; border-radius: 8px; padding: 2.5rem; text-align: center; cursor: pointer; transition: border-color 0.2s, background 0.2s; }
  .dropzone:hover, .dropzone.active { border-color: #58a6ff; background: rgba(88,166,255,0.04); }
  .badge { display: inline-block; background: #1a3d22; color: #3fb950; border-radius: 20px; padding: 0.2rem 0.75rem; font-family: monospace; font-size: 0.75rem; font-weight: 600; margin-top: 0.4rem; }
  .field { margin-bottom: 1rem; }
  .field label { display: block; font-family: monospace; font-size: 0.69rem; text-transform: uppercase; letter-spacing: 0.1em; color: #8b949e; margin-bottom: 0.3rem; }
  .field .hint { font-family: monospace; font-size: 0.71rem; color: #6e7681; margin-top: 0.2rem; }
  select { width: 100%; background: #0d1117; border: 1px solid #30363d; color: #e6edf3; border-radius: 4px; padding: 0.45rem 0.7rem; font-size: 0.85rem; font-family: monospace; outline: none; }
  select:focus { border-color: #58a6ff; }
  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  .btn-run { background: #238636; color: #fff; border: none; border-radius: 6px; padding: 0.6rem 1.4rem; font-family: monospace; font-size: 0.85rem; font-weight: 700; cursor: pointer; transition: background 0.15s; }
  .btn-run:hover:not(:disabled) { background: #2ea043; }
  .btn-run:disabled { background: #1a3d22; color: #4d7a55; cursor: not-allowed; }
  .btn-stop { background: #da3633; color: #fff; border: none; border-radius: 6px; padding: 0.45rem 0.9rem; font-family: monospace; font-size: 0.78rem; cursor: pointer; }
  .btn-dl { background: #1f6feb; color: #fff; border: none; border-radius: 6px; padding: 0.6rem 1.4rem; font-family: monospace; font-size: 0.85rem; font-weight: 700; cursor: pointer; margin-right: 0.5rem; margin-bottom: 0.5rem; }
  .btn-dl:hover { background: #388bfd; }
  .btn-row { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
  .prog-wrap { margin-top: 0.75rem; background: #21262d; border-radius: 3px; height: 5px; overflow: hidden; }
  .prog-fill { height: 100%; background: linear-gradient(90deg, #238636, #2ea043); border-radius: 3px; transition: width 0.3s; }
  .prog-text { font-family: monospace; font-size: 0.78rem; color: #8b949e; }
  .log { background: #0d1117; border: 1px solid #21262d; border-radius: 4px; padding: 0.6rem 0.75rem; max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.72rem; color: #8b949e; margin-top: 0.75rem; }
  .stats { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.6rem; margin-bottom: 1.25rem; }
  .stat-label { font-family: monospace; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.06em; color: #8b949e; margin-bottom: 0.2rem; }
  .stat-value { font-size: 1.5rem; font-weight: 700; }
  .green  { color: #3fb950; }
  .yellow { color: #e3b341; }
  .orange { color: #f0883e; }
  .blue   { color: #58a6ff; }
  .code-tag { background: #21262d; color: #8b949e; border-radius: 3px; padding: 0.1rem 0.4rem; font-family: monospace; font-size: 0.72rem; }
  .info-box { background: #1c2128; border: 1px solid #30363d; border-radius: 4px; padding: 0.65rem 0.85rem; font-family: monospace; font-size: 0.75rem; color: #8b949e; margin-bottom: 1rem; line-height: 1.6; }
  .legend-box { background: #1c2128; border: 1px solid #30363d; border-radius: 4px; padding: 0.65rem 0.85rem; font-family: monospace; font-size: 0.73rem; color: #8b949e; margin-bottom: 1rem; line-height: 2; }
  .tab-legend { display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; }
  .tab-pill { display: inline-flex; align-items: center; gap: 0.4rem; background: #21262d; border-radius: 4px; padding: 0.3rem 0.7rem; font-family: monospace; font-size: 0.73rem; }
  .tab-pill .swatch { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; }
  .footer { text-align: center; font-family: monospace; font-size: 0.7rem; color: #4d7a55; margin-top: 2rem; }
  .hidden { display: none; }
</style>
</head>
<body>
<div class="wrap">

  <div class="eyebrow"><span class="dot"></span>Maryland SDAT ¬∑ Public Records</div>
  <h1>Homeowner Verification</h1>
  <p class="subtitle">Three-tier matching ‚Äî Confirmed ¬∑ Possible ¬∑ No Match</p>

  <div class="card">
    <div class="card-title">‚ë† Upload Your CSV</div>
    <div class="dropzone" id="dropzone">
      <input type="file" accept=".csv" id="fileInput" class="hidden"/>
      <div id="dropEmpty">
        <div style="font-size:2rem;margin-bottom:0.5rem">‚¨ÜÔ∏è</div>
        <div style="color:#8b949e;font-size:0.9rem">Drop your CSV here, or click to browse</div>
      </div>
      <div id="dropLoaded" class="hidden">
        <div style="font-family:monospace;margin-bottom:0.4rem" id="fileName"></div>
        <span class="badge" id="recordCount"></span>
      </div>
    </div>
  </div>

  <div class="card hidden" id="mappingCard">
    <div class="card-title">‚ë° Confirm Column Mapping</div>
    <div class="info-box" id="detectedInfo"></div>
    <div class="grid2">
      <div class="field">
        <label>Decedent Name Column *</label>
        <select id="colName"></select>
        <div class="hint">Full legal name ‚Äî searched statewide by last name</div>
      </div>
      <div class="field">
        <label>Address Column (display only)</label>
        <select id="colAddr"></select>
        <div class="hint">Shown in output ‚Äî not used for SDAT search</div>
      </div>
    </div>
  </div>

  <div class="card hidden" id="runCard">
    <div class="card-title">‚ë¢ Verify Against SDAT</div>
    <div class="legend-box">
      <span style="color:#3fb950">‚úÖ CONFIRMED</span> ‚Äî First &amp; last name both match SDAT (legal names only)<br/>
      <span style="color:#e3b341">‚ö†Ô∏è POSSIBLE</span> ‚Äî Last name matches, first is a nickname or initial ‚Äî needs review<br/>
      <span style="color:#f0883e">‚ùå NO MATCH</span> ‚Äî No valid name match found in SDAT
    </div>
    <div class="btn-row">
      <button class="btn-run" id="btnRun">‚ñ∂&nbsp; Run Verification</button>
      <button class="btn-stop hidden" id="btnStop">Stop</button>
      <span class="prog-text hidden" id="progText"></span>
    </div>
    <div class="prog-wrap hidden" id="progWrap">
      <div class="prog-fill" id="progFill" style="width:0%"></div>
    </div>
    <div class="log hidden" id="logBox"></div>
  </div>

  <div class="card-success hidden" id="resultsCard">
    <div class="card-title-green">‚úì Verification Complete</div>
    <div class="stats">
      <div><div class="stat-label">Checked</div><div class="stat-value blue"   id="statTotal">0</div></div>
      <div><div class="stat-label">Confirmed</div><div class="stat-value green"  id="statConfirmed">0</div></div>
      <div><div class="stat-label">Possible</div><div class="stat-value yellow" id="statPossible">0</div></div>
      <div><div class="stat-label">No Match</div><div class="stat-value orange" id="statNone">0</div></div>
      <div><div class="stat-label">Hit Rate</div><div class="stat-value"        id="statRate">0%</div></div>
    </div>
    <div class="tab-legend">
      <div class="tab-pill"><span class="swatch" style="background:#238636"></span>Tab 1: Confirmed</div>
      <div class="tab-pill"><span class="swatch" style="background:#b3891b"></span>Tab 2: Possible ‚Äî Review</div>
      <div class="tab-pill"><span class="swatch" style="background:#b03a2e"></span>Tab 3: No Match</div>
    </div>
    <button class="btn-dl" id="btnDownload">‚¨á&nbsp; Download Excel (.xlsx)</button>
    <div style="margin-top:0.75rem;font-family:monospace;font-size:0.72rem;color:#6e7681">
      All tabs include original columns +
      <span class="code-tag">_Match_Status</span>
      <span class="code-tag">_Match_Reason</span>
      <span class="code-tag">_SDAT_Owner</span>
      <span class="code-tag">_SDAT_Address</span>
    </div>
  </div>

  <div class="footer">Maryland Open Data ¬∑ SDAT Real Property (x8a5-h2sy) ¬∑ Searches statewide by legal name</div>
</div>

<script>
const ENDPOINT = "https://opendata.maryland.gov/resource/x8a5-h2sy.json";
let csvData = null;
let confirmedRows = [], possibleRows = [], noMatchRows = [];
let aborted = false;

// ---------------------------------------------------------------------------
// NICKNAME MAP  legal name -> known nicknames
// ---------------------------------------------------------------------------
const NICKNAMES = {
  WILLIAM:["BILL","BILLY","WILL","WILLY","LIAM"],
  ROBERT:["BOB","BOBBY","ROB","ROBBIE"],
  JAMES:["JIM","JIMMY","JAMIE","JAY"],
  JOHN:["JACK","JOHNNY","JON"],
  MICHAEL:["MIKE","MIKEY","MICK","MICKEY"],
  RICHARD:["RICK","RICKY","DICK","RICH"],
  CHARLES:["CHUCK","CHARLIE","CHAS"],
  THOMAS:["TOM","TOMMY","THOM"],
  JOSEPH:["JOE","JOEY"],
  DAVID:["DAVE","DAVY"],
  EDWARD:["ED","EDDIE","NED","TED","TEDDY"],
  HENRY:["HANK","HAL"],
  HAROLD:["HAL","HARRY"],
  DONALD:["DON","DONNIE"],
  RONALD:["RON","RONNIE"],
  KENNETH:["KEN","KENNY"],
  STEVEN:["STEVE","STEVIE"],
  STEPHEN:["STEVE","STEVIE"],
  DANIEL:["DAN","DANNY"],
  ANTHONY:["TONY"],
  ANDREW:["ANDY","DREW"],
  FRANK:["FRANCIS","FRANKIE"],
  FRANCIS:["FRANK","FRAN"],
  PATRICK:["PAT","PATTY"],
  TIMOTHY:["TIM","TIMMY"],
  RAYMOND:["RAY"],
  LAWRENCE:["LARRY"],
  LARRY:["LAWRENCE"],
  WALTER:["WALT","WALLY"],
  PETER:["PETE"],
  EUGENE:["GENE"],
  ARTHUR:["ART","ARTIE"],
  ALBERT:["AL","BERT"],
  SAMUEL:["SAM","SAMMY"],
  FREDERICK:["FRED","FREDDY"],
  FRED:["FREDERICK","FREDDY"],
  GERALD:["JERRY","GERRY"],
  JERRY:["GERALD","GERRY"],
  LEONARD:["LEN","LENNY","LEO"],
  LOUIS:["LOU","LOUIE","LEWIS"],
  LEWIS:["LOU","LOUIE","LOUIS"],
  NATHANIEL:["NAT","NATE"],
  NICHOLAS:["NICK","NICKY"],
  NORMAN:["NORM"],
  RALPH:["RAFE"],
  RANDOLPH:["RANDY"],
  RANDY:["RANDOLPH"],
  RODNEY:["ROD"],
  RUSSELL:["RUSS"],
  STANLEY:["STAN"],
  THEODORE:["TED","TEDDY","THEO"],
  VICTOR:["VIC"],
  VINCENT:["VIN","VINCE","VINNY"],
  GEORGE:["GEORGIE"],
  CARL:["KARL"],
  HOWARD:["HOWIE"],
  DOUGLAS:["DOUG"],
  DENNIS:["DENNY"],
  CLIFFORD:["CLIFF"],
  JEROME:["JERRY"],
  HERMAN:["HERM"],
  FLOYD:["LLOYD"],
  ERNEST:["ERNIE"],
  EARL:["EARLE"],
  // Women
  ELIZABETH:["LIZ","LIZZIE","BETH","BETTY","BETTE","ELIZA","ELLIE","LIBBY","LISA","ELISE","ELSIE"],
  BETTY:["ELIZABETH","BETTE"],
  MARGARET:["MAGGIE","MEG","PEGGY","PEG","MARGE","MARGO","RITA"],
  MARY:["MARIE","MOLLY","MAE","MAY","MAMIE","POLLY"],
  PATRICIA:["PAT","PATTY","PATTI","TRICIA","TRISH"],
  BARBARA:["BARB","BARBIE","BABS"],
  DOROTHY:["DOT","DOTTIE"],
  HELEN:["NELL","NELLIE"],
  VIRGINIA:["GINNY","GINGER"],
  CATHERINE:["CATHY","KATHY","KATE","KATIE","KAY"],
  KATHERINE:["KATHY","KATE","KATIE","KAY","CATHY"],
  KATHLEEN:["KATHY","KATE","KATIE","KAY"],
  CAROLYN:["CAROL","CARRIE","LYNN"],
  CAROL:["CAROLE","CAROLYN","CARRIE"],
  DIANE:["DIANNE","DI"],
  JUDITH:["JUDY"],
  JUDY:["JUDITH"],
  PAMELA:["PAM"],
  SANDRA:["SANDY","SANDI"],
  SHIRLEY:["SHIRL"],
  SUSAN:["SUE","SUSIE","SUZY"],
  TERESA:["TERRY","TERI","TESS","TESSA"],
  THERESA:["TERRY","TERI","TESS","TESSA"],
  DEBORAH:["DEB","DEBBIE"],
  DEBRA:["DEB","DEBBIE"],
  CYNTHIA:["CINDY"],
  CONSTANCE:["CONNIE"],
  CONNIE:["CONSTANCE"],
  BEVERLY:["BEV"],
  FRANCES:["FRAN","FRANNIE"],
  GERALDINE:["GERI","JERRY"],
  LILLIAN:["LILY","LIL"],
  LORRAINE:["LORI"],
  MILDRED:["MILLIE"],
  ROSEMARY:["ROSIE","ROSE"],
  EVELYN:["EVE","EVIE"],
  JOSEPHINE:["JO","JOSIE"],
  JOANNE:["JO","JOAN"],
  ROBERTA:["BOBBIE"],
  VIVIAN:["VIV"],
  PHYLLIS:["PHIL"],
  DOLORES:["DEE","LOLA"],
  MARILYN:["LYNN"],
  WANDA:["WENDI"],
  LAURA:["LAURIE","LORI"],
  LORI:["LAURA","LAURIE"],
};

const NICKNAME_REVERSE = {};
for (const [legal, nicks] of Object.entries(NICKNAMES)) {
  for (const nick of nicks) {
    if (!NICKNAME_REVERSE[nick]) NICKNAME_REVERSE[nick] = [];
    if (!NICKNAME_REVERSE[nick].includes(legal)) NICKNAME_REVERSE[nick].push(legal);
  }
}

const STRIP_SUFFIXES = new Set(["JR","SR","II","III","IV","EST","TR","TRUSTEE","ETAL","ET","AL","THE","AND","OF","MR","MRS","MS","DR"]);

function normName(s) {
  return (s || "").toUpperCase().replace(/[^A-Z\s]/g," ").replace(/\s+/g," ").trim();
}

function tokenize(s) {
  return normName(s).split(" ").filter(t => t.length > 0 && !STRIP_SUFFIXES.has(t));
}

// Core match classifier ‚Äî returns { status, reason }
function classifyMatch(decedentFull, sdatOwner) {
  const dTokens = tokenize(decedentFull);
  const sTokens = tokenize(sdatOwner);
  const sNorm   = normName(sdatOwner);

  if (!dTokens.length || !sTokens.length) return { status:"none", reason:"Empty name" };

  // Last name is the last non-suffix token of the decedent name
  // (handles "JOHN THOMAS SMITH SR" -> SMITH)
  const dLast = dTokens[dTokens.length - 1];

  // Check last name present in SDAT record
  if (!sNorm.includes(dLast)) {
    return { status:"none", reason:`Last name "${dLast}" not in SDAT "${sdatOwner}"` };
  }

  // Collect decedent first-name candidates (everything except the last token)
  const dFirstCandidates = dTokens.slice(0, -1);
  if (!dFirstCandidates.length) {
    return { status:"none", reason:"Only one name token ‚Äî cannot confirm without first name" };
  }

  // --- Try CONFIRMED: exact first name token match ---
  for (const fn of dFirstCandidates) {
    if (fn.length <= 1) continue; // skip bare initials
    if (sNorm.includes(fn)) {
      return { status:"confirmed", reason:`"${dLast}" + "${fn}" both matched in SDAT` };
    }
  }

  // --- Try POSSIBLE: initial-only in SDAT ---
  for (const fn of dFirstCandidates) {
    if (fn.length <= 1) continue;
    if (sTokens.includes(fn[0])) {
      return { status:"possible", reason:`Last name matched; SDAT has initial "${fn[0]}" only (decedent: "${fn}")` };
    }
  }

  // --- Try POSSIBLE: nickname match ---
  for (const fn of dFirstCandidates) {
    if (fn.length <= 1) continue;
    // decedent has legal name, SDAT might have nickname
    for (const nick of (NICKNAMES[fn] || [])) {
      if (sNorm.includes(nick)) {
        return { status:"possible", reason:`Last name matched; nickname "${nick}" found (legal: "${fn}")` };
      }
    }
    // decedent field might have nickname, SDAT has legal name
    for (const legal of (NICKNAME_REVERSE[fn] || [])) {
      if (sNorm.includes(legal)) {
        return { status:"possible", reason:`Last name matched; "${fn}" may be nickname for "${legal}" in SDAT` };
      }
    }
  }

  return { status:"none", reason:`Last name "${dLast}" found but no first name or nickname match in SDAT "${sdatOwner}"` };
}

// Search SDAT by last name statewide
async function lookupByName(decedentFull) {
  const tokens = tokenize(decedentFull);
  if (!tokens.length) return { records:null, error:"No name tokens" };

  const lastName = tokens[tokens.length - 1];
  if (lastName.length < 2) return { records:null, error:"Last name too short" };

  const where = `upper(ownname1) like '%${lastName}%' OR upper(ownname2) like '%${lastName}%'`;
  const url   = ENDPOINT + "?$limit=20&$where=" + encodeURIComponent(where);
  try {
    const r = await fetch(url);
    if (!r.ok) return { records:null, error:"API error " + r.status };
    const d = await r.json();
    return { records: d.length ? d : null, error:null };
  } catch(e) {
    return { records:null, error:e.message };
  }
}

// ---------------------------------------------------------------------------
// CSV parser
// ---------------------------------------------------------------------------
function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  if (lines.length < 2) return { headers:[], rows:[] };
  function splitRow(line) {
    const out=[]; let cur="",q=false;
    for (let i=0;i<line.length;i++) {
      const ch=line[i];
      if (ch==='"') { if(q&&line[i+1]==='"'){cur+='"';i++;}else{q=!q;} continue; }
      if (ch===','&&!q){out.push(cur.trim());cur="";continue;}
      cur+=ch;
    }
    out.push(cur.trim()); return out;
  }
  const headers = splitRow(lines[0]);
  const rows = lines.slice(1).filter(l=>l.trim()).map(l=>{
    const v=splitRow(l);
    return Object.fromEntries(headers.map((h,i)=>[h,v[i]!==undefined?v[i]:""]));
  });
  return { headers, rows };
}

function autoDetect(headers) {
  const h = headers.map(x=>x.toLowerCase());
  const find = (...words) => { const idx=h.findIndex(c=>words.some(w=>c.includes(w))); return idx>=0?headers[idx]:""; };
  return { name:find("decedent full","decedent","deceased","full name"), addr:find("decedent address","address") };
}

function populateSelect(id, headers, selected, addBlank) {
  const el=document.getElementById(id); el.innerHTML="";
  if (addBlank){const o=document.createElement("option");o.value="";o.textContent="‚Äî not used ‚Äî";el.appendChild(o);}
  headers.forEach(h=>{const o=document.createElement("option");o.value=h;o.textContent=h;if(h===selected)o.selected=true;el.appendChild(o);});
}

function loadFile(file) {
  if (!file||!file.name.endsWith(".csv")) return;
  const reader=new FileReader();
  reader.onload=e=>{
    csvData=parseCSV(e.target.result);
    document.getElementById("fileName").textContent="üìÑ "+file.name;
    document.getElementById("recordCount").textContent=csvData.rows.length.toLocaleString()+" records loaded";
    document.getElementById("dropEmpty").classList.add("hidden");
    document.getElementById("dropLoaded").classList.remove("hidden");
    const d=autoDetect(csvData.headers);
    populateSelect("colName",csvData.headers,d.name,false);
    populateSelect("colAddr",csvData.headers,d.addr,true);
    document.getElementById("detectedInfo").innerHTML=
      `Auto-detected &nbsp;‚Üí&nbsp; <strong style="color:#e6edf3">Name:</strong> ${d.name||"?"} &nbsp;|&nbsp; `+
      `<strong style="color:#e6edf3">Address:</strong> ${d.addr||"(display only)"}`;
    document.getElementById("mappingCard").classList.remove("hidden");
    document.getElementById("runCard").classList.remove("hidden");
    document.getElementById("resultsCard").classList.add("hidden");
    document.getElementById("logBox").innerHTML="";
    document.getElementById("logBox").classList.add("hidden");
  };
  reader.readAsText(file);
}

const dz=document.getElementById("dropzone");
dz.addEventListener("click",()=>document.getElementById("fileInput").click());
dz.addEventListener("dragover",e=>{e.preventDefault();dz.classList.add("active");});
dz.addEventListener("dragleave",()=>dz.classList.remove("active"));
dz.addEventListener("drop",e=>{e.preventDefault();dz.classList.remove("active");loadFile(e.dataTransfer.files[0]);});
document.getElementById("fileInput").addEventListener("change",e=>loadFile(e.target.files[0]));

function addLog(msg) {
  const box=document.getElementById("logBox");
  box.classList.remove("hidden");
  const line=document.createElement("div");line.textContent=msg;
  box.appendChild(line);
  if (box.children.length>400) box.removeChild(box.firstChild);
  box.scrollTop=box.scrollHeight;
}

// ---------------------------------------------------------------------------
// Run
// ---------------------------------------------------------------------------
document.getElementById("btnRun").addEventListener("click",async()=>{
  if (!csvData) return;
  const nameCol=document.getElementById("colName").value;
  const addrCol=document.getElementById("colAddr").value;
  if (!nameCol){alert("Please select the Decedent Name column.");return;}

  aborted=false; confirmedRows=[]; possibleRows=[]; noMatchRows=[];
  const btnRun=document.getElementById("btnRun");
  btnRun.disabled=true; btnRun.textContent="Running‚Ä¶";
  document.getElementById("btnStop").classList.remove("hidden");
  document.getElementById("progWrap").classList.remove("hidden");
  document.getElementById("progText").classList.remove("hidden");
  document.getElementById("logBox").innerHTML="";
  document.getElementById("logBox").classList.remove("hidden");
  document.getElementById("resultsCard").classList.add("hidden");

  const total=csvData.rows.length;

  for (let i=0;i<total;i++) {
    if (aborted){addLog("‚ö† Stopped at row "+(i+1));break;}

    const row=csvData.rows[i];
    const name=(row[nameCol]||"").trim();

    let matchStatus="none", matchReason="", sdatOwner="", sdatAddr="";

    if (!name) {
      matchReason="Empty name";
    } else {
      const {records,error}=await lookupByName(name);

      if (error&&!records) {
        matchReason="Lookup error: "+error;
        addLog(`Row ${i+1}: "${name}" ‚Äî ${matchReason}`);
      } else if (records) {
        let bestStatus="none", bestReason="", bestOwner="", bestAddr="";

        for (const rec of records) {
          const o1=(rec.ownname1||"").trim(), o2=(rec.ownname2||"").trim();
          for (const candidate of [o1,o2].filter(Boolean)) {
            const {status,reason}=classifyMatch(name,candidate);
            if (status==="confirmed") {
              bestStatus="confirmed"; bestReason=reason;
              bestOwner=[o1,o2].filter(Boolean).join(" / ");
              bestAddr=[rec.premsnum,rec.premsnam,rec.premcity,rec.premzip].filter(Boolean).join(" ");
              break;
            } else if (status==="possible"&&bestStatus!=="confirmed") {
              bestStatus="possible"; bestReason=reason;
              bestOwner=[o1,o2].filter(Boolean).join(" / ");
              bestAddr=[rec.premsnum,rec.premsnam,rec.premcity,rec.premzip].filter(Boolean).join(" ");
            }
          }
          if (bestStatus==="confirmed") break;
        }

        matchStatus=bestStatus; matchReason=bestReason||`${records.length} record(s) found, no name match`;
        sdatOwner=bestOwner; sdatAddr=bestAddr;

        if (matchStatus==="none") {
          const sample=records.slice(0,2).map(r=>r.ownname1||"?").join(", ");
          addLog(`Row ${i+1}: ‚ùå "${name}" ‚Äî no match (SDAT sample: ${sample})`);
        } else if (matchStatus==="possible") {
          addLog(`Row ${i+1}: ‚ö†Ô∏è "${name}" ‚Äî possible (${matchReason})`);
        }
      } else {
        matchReason="No SDAT records for this last name";
        addLog(`Row ${i+1}: ‚ùå "${name}" ‚Äî ${matchReason}`);
      }
    }

    const outRow=Object.assign({},row);
    outRow["_Match_Status"]=matchStatus==="confirmed"?"‚úÖ CONFIRMED":matchStatus==="possible"?"‚ö†Ô∏è POSSIBLE":"‚ùå NO MATCH";
    outRow["_Match_Reason"]=matchReason;
    outRow["_SDAT_Owner"]=sdatOwner;
    outRow["_SDAT_Address"]=sdatAddr;

    if (matchStatus==="confirmed")     confirmedRows.push(outRow);
    else if (matchStatus==="possible") possibleRows.push(outRow);
    else                               noMatchRows.push(outRow);

    const pct=Math.round(((i+1)/total)*100);
    document.getElementById("progFill").style.width=pct+"%";
    document.getElementById("progText").innerHTML=
      `${pct}% &nbsp;¬∑&nbsp; `+
      `<span style="color:#3fb950">${confirmedRows.length} confirmed</span> &nbsp;¬∑&nbsp; `+
      `<span style="color:#e3b341">${possibleRows.length} possible</span> &nbsp;¬∑&nbsp; `+
      `<span style="color:#f0883e">${noMatchRows.length} no match</span>`;

    await new Promise(r=>setTimeout(r,120));
  }

  document.getElementById("statTotal").textContent    =total.toLocaleString();
  document.getElementById("statConfirmed").textContent=confirmedRows.length.toLocaleString();
  document.getElementById("statPossible").textContent =possibleRows.length.toLocaleString();
  document.getElementById("statNone").textContent     =noMatchRows.length.toLocaleString();
  document.getElementById("statRate").textContent     =total?Math.round(((confirmedRows.length+possibleRows.length)/total)*100)+"%":"0%";

  btnRun.disabled=false; btnRun.textContent="‚ñ∂  Run Verification";
  document.getElementById("btnStop").classList.add("hidden");
  document.getElementById("resultsCard").classList.remove("hidden");
});

document.getElementById("btnStop").addEventListener("click",()=>{aborted=true;});

// ---------------------------------------------------------------------------
// Download 3-tab XLSX
// ---------------------------------------------------------------------------
document.getElementById("btnDownload").addEventListener("click",()=>{
  const origHeaders=csvData.headers;
  const extraCols=["_Match_Status","_Match_Reason","_SDAT_Owner","_SDAT_Address"];
  const outHeaders=[...origHeaders,...extraCols];

  function toSheet(rows) {
    return XLSX.utils.aoa_to_sheet([outHeaders,...rows.map(r=>outHeaders.map(h=>r[h]||""))]);
  }
  function styleHeader(ws,n,bgHex,fgHex) {
    for (let c=0;c<n;c++) {
      const cell=XLSX.utils.encode_cell({r:0,c});
      if (!ws[cell]) continue;
      ws[cell].s={font:{bold:true,color:{rgb:fgHex}},fill:{fgColor:{rgb:bgHex}},alignment:{horizontal:"center"}};
    }
  }

  const wb=XLSX.utils.book_new();
  const n=outHeaders.length;

  const ws1=toSheet(confirmedRows); styleHeader(ws1,n,"1a3d22","3fb950");
  XLSX.utils.book_append_sheet(wb,ws1,"Confirmed");

  const ws2=toSheet(possibleRows);  styleHeader(ws2,n,"2d2208","e3b341");
  XLSX.utils.book_append_sheet(wb,ws2,"Possible - Review");

  const ws3=toSheet(noMatchRows);   styleHeader(ws3,n,"2d0f0e","f0883e");
  XLSX.utils.book_append_sheet(wb,ws3,"No Match");

  XLSX.writeFile(wb,`homeowner_verification_${new Date().toISOString().slice(0,10)}.xlsx`);
});
</script>
</body>
</html>
