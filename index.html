import { useState, useCallback, useRef } from "react";

const ENDPOINT = "https://opendata.maryland.gov/resource/x8a5-h2sy.json";

function fuzzyMatch(decedent, owner) {
  if (!decedent || !owner) return false;
  const norm = s => s.toUpperCase().replace(/[^A-Z\s]/g, "").trim();
  const tokens = norm(decedent).split(/\s+/).filter(t => t.length > 1);
  const ownerNorm = norm(owner);
  return tokens.every(t => ownerNorm.includes(t));
}

async function lookup(address, city, zip) {
  const m = address.trim().match(/^(\d+)\s+(.+?)(?:,.*)?$/);
  if (!m && !zip) return null;
  const conditions = [];
  if (m) {
    conditions.push(`premise_address_number='${m[1]}'`);
    conditions.push(`upper(premise_street_name) like '%25${encodeURIComponent(m[2].toUpperCase().split(" ")[0])}%25'`);
  }
  if (city) conditions.push(`upper(premise_city) like '%25${encodeURIComponent(city.toUpperCase())}%25'`);
  if (zip) conditions.push(`premise_zip_code='${zip.replace(/\D/g,"").slice(0,5)}'`);
  try {
    const r = await fetch(`${ENDPOINT}?$limit=5&$where=${conditions.join(" AND ")}`);
    if (!r.ok) return null;
    const d = await r.json();
    return d.length ? d : null;
  } catch { return null; }
}

function parseCSV(text) {
  const lines = text.trim().split("\n");
  if (lines.length < 2) return { headers: [], rows: [] };
  const split = line => {
    const out = []; let cur = "", q = false;
    for (const ch of line) {
      if (ch === '"') { q = !q; continue; }
      if (ch === ',' && !q) { out.push(cur.trim()); cur = ""; continue; }
      cur += ch;
    }
    out.push(cur.trim());
    return out;
  };
  const headers = split(lines[0]);
  const rows = lines.slice(1).filter(l => l.trim()).map(l => {
    const v = split(l);
    return Object.fromEntries(headers.map((h, i) => [h, v[i] || ""]));
  });
  return { headers, rows };
}

function toCSVLine(headers, row) {
  return headers.map(h => `"${(row[h]||"").replace(/"/g,'""')}"`).join(",");
}

function autoDetect(headers) {
  const h = headers.map(x => x.toLowerCase());
  const find = (...words) => headers[h.findIndex(c => words.some(w => c.includes(w)))] || "";
  return {
    name: find("decedent","deceased","name","owner"),
    addr: find("address","street","property"),
    city: find("city"),
    zip:  find("zip","postal"),
  };
}

function Field({ label, hint, children }) {
  return (
    <div className="mb-4">
      <div className="text-xs font-mono uppercase tracking-widest text-gray-400 mb-1">{label}</div>
      {children}
      {hint && <div className="text-xs font-mono text-gray-600 mt-1">{hint}</div>}
    </div>
  );
}

function Select({ value, onChange, options, placeholder }) {
  return (
    <select
      value={value}
      onChange={e => onChange(e.target.value)}
      className="w-full bg-gray-900 border border-gray-700 text-gray-200 rounded px-3 py-2 text-sm font-mono focus:outline-none focus:border-blue-500"
    >
      {placeholder && <option value="">{placeholder}</option>}
      {options.map(o => <option key={o} value={o}>{o}</option>)}
    </select>
  );
}

export default function App() {
  const [csvData, setCsvData]     = useState(null);
  const [fileName, setFileName]   = useState("");
  const [cols, setCols]           = useState({ name:"", addr:"", city:"", zip:"" });
  const [dragging, setDragging]   = useState(false);
  const [running, setRunning]     = useState(false);
  const [done, setDone]           = useState(0);
  const [total, setTotal]         = useState(0);
  const [matchCount, setMatchCount] = useState(0);
  const [log, setLog]             = useState([]);
  const [result, setResult]       = useState(null);
  const abortRef = useRef(false);

  const loadFile = useCallback(f => {
    if (!f || !f.name.endsWith(".csv")) return;
    setFileName(f.name);
    setResult(null); setLog([]); setDone(0); setTotal(0); setMatchCount(0);
    const reader = new FileReader();
    reader.onload = e => {
      const parsed = parseCSV(e.target.result);
      setCsvData(parsed);
      const d = autoDetect(parsed.headers);
      setCols(d);
    };
    reader.readAsText(f);
  }, []);

  const onDrop = useCallback(e => {
    e.preventDefault(); setDragging(false);
    loadFile(e.dataTransfer.files[0]);
  }, [loadFile]);

  const run = async () => {
    if (!csvData || !cols.name) return;
    setRunning(true); setResult(null); setLog([]); setMatchCount(0);
    abortRef.current = false;
    const matches = [];
    setTotal(csvData.rows.length); setDone(0);

    for (let i = 0; i < csvData.rows.length; i++) {
      if (abortRef.current) break;
      const row = csvData.rows[i];
      const name = row[cols.name] || "";
      const records = await lookup(row[cols.addr]||"", row[cols.city]||"", row[cols.zip]||"");

      let matched = false, verifiedOwner = "", verifiedAddr = "";
      if (records) {
        for (const rec of records) {
          const o1 = rec.owner_name_1 || "", o2 = rec.owner_name_2 || "";
          if (fuzzyMatch(name, o1) || fuzzyMatch(name, o2)) {
            matched = true;
            verifiedOwner = [o1,o2].filter(Boolean).join(" / ");
            verifiedAddr  = `${rec.premise_address_number||""} ${rec.premise_street_name||""}, ${rec.premise_city||""} ${rec.premise_zip_code||""}`.trim();
            break;
          }
        }
        if (!matched) setLog(l => [...l, `Row ${i+1}: "${name}" ‚Äî address found, owner mismatch (SDAT: ${records[0].owner_name_1||"?"})`]);
      } else {
        setLog(l => [...l, `Row ${i+1}: "${name}" ‚Äî no record found`]);
      }

      if (matched) {
        matches.push({ ...row, _Verified_Owner: verifiedOwner, _Verified_Address: verifiedAddr, _Status: "MATCH" });
        setMatchCount(matches.length);
      }
      setDone(i + 1);
      await new Promise(r => setTimeout(r, 120));
    }

    const outHeaders = [...csvData.headers, "_Verified_Owner","_Verified_Address","_Status"];
    const csv = [outHeaders.join(","), ...matches.map(r => toCSVLine(outHeaders, r))].join("\n");
    setResult({ csv, count: matches.length });
    setRunning(false);
  };

  const download = () => {
    if (!result) return;
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([result.csv], { type:"text/csv" }));
    a.download = `verified_matches_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
  };

  const pct = total ? Math.round((done/total)*100) : 0;
  const headers = csvData?.headers || [];

  return (
    <div className="min-h-screen bg-gray-950 text-gray-200 p-6">
      <div className="max-w-2xl mx-auto">

        {/* Header */}
        <div className="mb-8">
          <div className="flex items-center gap-2 mb-2">
            <div className="w-2 h-2 rounded-full bg-green-500"></div>
            <span className="text-xs font-mono uppercase tracking-widest text-green-500">Maryland SDAT ¬∑ Public Records</span>
          </div>
          <h1 className="text-3xl font-bold text-white mb-1">Homeowner Verification</h1>
          <p className="text-gray-400 text-sm">Cross-reference your prospect list against Maryland property records</p>
        </div>

        {/* Step 1 */}
        <div className="bg-gray-900 border border-gray-700 rounded-lg p-5 mb-4">
          <div className="text-sm text-blue-400 border-b border-gray-800 pb-2 mb-4">‚ë† Upload Your CSV</div>
          <div
            className={`border-2 border-dashed rounded-lg p-10 text-center cursor-pointer transition-colors ${dragging ? "border-blue-500 bg-blue-950" : "border-gray-700 hover:border-gray-500"}`}
            onDragOver={e => { e.preventDefault(); setDragging(true); }}
            onDragLeave={() => setDragging(false)}
            onDrop={onDrop}
            onClick={() => document.getElementById("f").click()}
          >
            <input id="f" type="file" accept=".csv" className="hidden" onChange={e => loadFile(e.target.files[0])} />
            {csvData ? (
              <div>
                <div className="font-mono text-sm mb-2">üìÑ {fileName}</div>
                <span className="bg-green-900 text-green-400 text-xs font-mono font-semibold px-3 py-1 rounded-full">
                  {csvData.rows.length.toLocaleString()} records loaded
                </span>
              </div>
            ) : (
              <div>
                <div className="text-3xl mb-2">‚¨ÜÔ∏è</div>
                <div className="text-gray-400 text-sm">Drop your CSV here, or click to browse</div>
              </div>
            )}
          </div>
        </div>

        {/* Step 2 */}
        {csvData && (
          <div className="bg-gray-900 border border-gray-700 rounded-lg p-5 mb-4">
            <div className="text-sm text-blue-400 border-b border-gray-800 pb-2 mb-4">‚ë° Map Your Columns</div>

            <Field label="Decedent / Owner Name *" hint="The name to match against SDAT owner records">
              <Select value={cols.name} onChange={v => setCols(c=>({...c,name:v}))} options={headers} />
            </Field>

            <div className="grid grid-cols-2 gap-4">
              <Field label="Property Address *" hint='e.g. "123 Main St"'>
                <Select value={cols.addr} onChange={v => setCols(c=>({...c,addr:v}))} options={headers} placeholder="‚Äî select ‚Äî" />
              </Field>
              <Field label="City" hint="Improves accuracy">
                <Select value={cols.city} onChange={v => setCols(c=>({...c,city:v}))} options={headers} placeholder="‚Äî optional ‚Äî" />
              </Field>
            </div>

            <div className="max-w-xs">
              <Field label="ZIP Code" hint="Strongly recommended">
                <Select value={cols.zip} onChange={v => setCols(c=>({...c,zip:v}))} options={headers} placeholder="‚Äî optional ‚Äî" />
              </Field>
            </div>
          </div>
        )}

        {/* Step 3 */}
        {csvData && (
          <div className="bg-gray-900 border border-gray-700 rounded-lg p-5 mb-4">
            <div className="text-sm text-blue-400 border-b border-gray-800 pb-2 mb-4">‚ë¢ Verify Against SDAT</div>

            <div className="flex items-center gap-3 flex-wrap">
              <button
                onClick={run}
                disabled={running || !cols.name}
                className="bg-green-700 hover:bg-green-600 disabled:bg-green-950 disabled:text-green-800 text-white font-mono text-sm font-semibold px-5 py-2 rounded-md transition-colors"
              >
                {running ? `Checking‚Ä¶ ${done} / ${total}` : "‚ñ∂  Run Verification"}
              </button>
              {running && (
                <button onClick={() => { abortRef.current = true; }} className="bg-red-700 hover:bg-red-600 text-white font-mono text-xs px-3 py-2 rounded-md">
                  Stop
                </button>
              )}
              {total > 0 && (
                <span className="font-mono text-sm text-gray-400">
                  {pct}% ¬∑ <span className="text-green-400">{matchCount} matches</span>
                </span>
              )}
            </div>

            {running && (
              <div className="mt-3 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                <div className="h-full bg-green-600 rounded-full transition-all" style={{ width: `${pct}%` }}></div>
              </div>
            )}

            {log.length > 0 && (
              <div className="mt-3 bg-gray-950 border border-gray-800 rounded p-3 max-h-32 overflow-y-auto font-mono text-xs text-gray-500">
                {log.slice(-80).map((l, i) => <div key={i}>{l}</div>)}
              </div>
            )}
          </div>
        )}

        {/* Results */}
        {result && (
          <div className="bg-gray-900 border border-green-700 rounded-lg p-5 mb-4">
            <div className="text-sm text-green-400 border-b border-gray-800 pb-2 mb-4">‚úì Verification Complete</div>
            <div className="grid grid-cols-3 gap-6 mb-5">
              <div>
                <div className="text-xs font-mono uppercase tracking-widest text-gray-500 mb-1">Total Checked</div>
                <div className="text-3xl font-bold">{done.toLocaleString()}</div>
              </div>
              <div>
                <div className="text-xs font-mono uppercase tracking-widest text-gray-500 mb-1">Verified Matches</div>
                <div className="text-3xl font-bold text-green-400">{result.count.toLocaleString()}</div>
              </div>
              <div>
                <div className="text-xs font-mono uppercase tracking-widest text-gray-500 mb-1">Match Rate</div>
                <div className="text-3xl font-bold">{done ? Math.round((result.count/done)*100) : 0}%</div>
              </div>
            </div>
            <button onClick={download} className="bg-blue-700 hover:bg-blue-600 text-white font-mono text-sm font-semibold px-5 py-2 rounded-md transition-colors">
              ‚¨á  Download Verified Matches CSV
            </button>
            <div className="mt-3 font-mono text-xs text-gray-600">
              Adds columns: <code className="bg-gray-800 px-1 rounded">_Verified_Owner</code> <code className="bg-gray-800 px-1 rounded">_Verified_Address</code> <code className="bg-gray-800 px-1 rounded">_Status</code>
            </div>
          </div>
        )}

        <div className="text-center font-mono text-xs text-gray-700 mt-6">
          Data sourced from Maryland Open Data ¬∑ SDAT Real Property Assessments ¬∑ Updated Tue‚ÄìSat
        </div>
      </div>
    </div>
  );
}
