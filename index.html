<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MD Homeowner Verification</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #0d1117; color: #e6edf3; font-family: Georgia, serif; min-height: 100vh; padding: 2rem 1rem; }
  .wrap { max-width: 700px; margin: 0 auto; }
  .eyebrow { display: flex; align-items: center; gap: 8px; font-family: monospace; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.12em; color: #3fb950; margin-bottom: 0.5rem; }
  .dot { width: 8px; height: 8px; border-radius: 50%; background: #238636; flex-shrink: 0; }
  h1 { font-size: 1.9rem; font-weight: 700; color: #fff; margin-bottom: 0.25rem; }
  .subtitle { color: #8b949e; font-size: 0.9rem; font-style: italic; margin-bottom: 2rem; }
  .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.25rem; }
  .card-success { background: #161b22; border: 1px solid #238636; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.25rem; }
  .card-title { font-family: monospace; font-size: 0.85rem; color: #58a6ff; border-bottom: 1px solid #21262d; padding-bottom: 0.6rem; margin-bottom: 1.25rem; }
  .card-title-green { font-family: monospace; font-size: 0.85rem; color: #3fb950; border-bottom: 1px solid #21262d; padding-bottom: 0.6rem; margin-bottom: 1.25rem; }
  .dropzone { border: 2px dashed #30363d; border-radius: 8px; padding: 2.5rem; text-align: center; cursor: pointer; transition: border-color 0.2s, background 0.2s; }
  .dropzone:hover, .dropzone.active { border-color: #58a6ff; background: rgba(88,166,255,0.04); }
  .dropzone-icon { font-size: 2.2rem; margin-bottom: 0.5rem; }
  .dropzone-text { color: #8b949e; font-size: 0.9rem; }
  .badge { display: inline-block; background: #1a3d22; color: #3fb950; border-radius: 20px; padding: 0.2rem 0.75rem; font-family: monospace; font-size: 0.75rem; font-weight: 600; margin-top: 0.4rem; }
  .field { margin-bottom: 1rem; }
  .field label { display: block; font-family: monospace; font-size: 0.69rem; text-transform: uppercase; letter-spacing: 0.1em; color: #8b949e; margin-bottom: 0.3rem; }
  .field .hint { font-family: monospace; font-size: 0.71rem; color: #6e7681; margin-top: 0.2rem; }
  select { width: 100%; background: #0d1117; border: 1px solid #30363d; color: #e6edf3; border-radius: 4px; padding: 0.45rem 0.7rem; font-size: 0.85rem; font-family: monospace; outline: none; }
  select:focus { border-color: #58a6ff; }
  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  .btn-run { background: #238636; color: #fff; border: none; border-radius: 6px; padding: 0.6rem 1.4rem; font-family: monospace; font-size: 0.85rem; font-weight: 700; cursor: pointer; transition: background 0.15s; }
  .btn-run:hover:not(:disabled) { background: #2ea043; }
  .btn-run:disabled { background: #1a3d22; color: #4d7a55; cursor: not-allowed; }
  .btn-stop { background: #da3633; color: #fff; border: none; border-radius: 6px; padding: 0.45rem 0.9rem; font-family: monospace; font-size: 0.78rem; cursor: pointer; }
  .btn-dl { background: #1f6feb; color: #fff; border: none; border-radius: 6px; padding: 0.6rem 1.4rem; font-family: monospace; font-size: 0.85rem; font-weight: 700; cursor: pointer; }
  .btn-dl:hover { background: #388bfd; }
  .btn-row { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
  .prog-wrap { margin-top: 0.75rem; background: #21262d; border-radius: 3px; height: 5px; overflow: hidden; }
  .prog-fill { height: 100%; background: linear-gradient(90deg, #238636, #2ea043); border-radius: 3px; transition: width 0.3s; }
  .prog-text { font-family: monospace; font-size: 0.82rem; color: #8b949e; }
  .log { background: #0d1117; border: 1px solid #21262d; border-radius: 4px; padding: 0.6rem 0.75rem; max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.72rem; color: #8b949e; margin-top: 0.75rem; }
  .stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 1.25rem; }
  .stat-label { font-family: monospace; font-size: 0.69rem; text-transform: uppercase; letter-spacing: 0.1em; color: #8b949e; margin-bottom: 0.2rem; }
  .stat-value { font-size: 2rem; font-weight: 700; }
  .green { color: #3fb950; }
  .code-tag { background: #21262d; color: #8b949e; border-radius: 3px; padding: 0.1rem 0.4rem; font-family: monospace; font-size: 0.72rem; }
  .footer { text-align: center; font-family: monospace; font-size: 0.7rem; color: #4d7a55; margin-top: 2rem; }
  .hidden { display: none; }
  .info-box { background: #1c2128; border: 1px solid #30363d; border-radius: 4px; padding: 0.6rem 0.75rem; font-family: monospace; font-size: 0.75rem; color: #8b949e; margin-bottom: 1rem; line-height: 1.5; }
</style>
</head>
<body>
<div class="wrap">

  <div class="eyebrow"><span class="dot"></span>Maryland SDAT ¬∑ Public Records</div>
  <h1>Homeowner Verification</h1>
  <p class="subtitle">Cross-reference your prospect list against Maryland property records</p>

  <!-- Step 1: Upload -->
  <div class="card">
    <div class="card-title">‚ë† Upload Your CSV</div>
    <div class="dropzone" id="dropzone">
      <input type="file" accept=".csv" id="fileInput" class="hidden"/>
      <div id="dropEmpty">
        <div class="dropzone-icon">‚¨ÜÔ∏è</div>
        <div class="dropzone-text">Drop your CSV here, or click to browse</div>
      </div>
      <div id="dropLoaded" class="hidden">
        <div style="font-family:monospace;margin-bottom:0.4rem" id="fileName"></div>
        <span class="badge" id="recordCount"></span>
      </div>
    </div>
  </div>

  <!-- Step 2: Column Mapping -->
  <div class="card hidden" id="mappingCard">
    <div class="card-title">‚ë° Map Your Columns</div>
    <div class="info-box">
      üîç Lookup strategy: searches SDAT by <strong>property address + ZIP</strong>, then checks if the decedent's last name appears anywhere in the SDAT owner name field.
    </div>
    <div class="field">
      <label>Decedent / Owner Name *</label>
      <select id="colName"></select>
      <div class="hint">Last name will be used to match against SDAT owner records</div>
    </div>
    <div class="grid2">
      <div class="field">
        <label>Property Address *</label>
        <select id="colAddr"></select>
        <div class="hint">Full address e.g. "123 Main St" or just street</div>
      </div>
      <div class="field">
        <label>City</label>
        <select id="colCity"></select>
        <div class="hint">Improves accuracy</div>
      </div>
    </div>
    <div class="field" style="max-width:320px">
      <label>ZIP Code (strongly recommended)</label>
      <select id="colZip"></select>
    </div>
  </div>

  <!-- Step 3: Run -->
  <div class="card hidden" id="runCard">
    <div class="card-title">‚ë¢ Verify Against SDAT</div>
    <div class="btn-row">
      <button class="btn-run" id="btnRun">‚ñ∂&nbsp; Run Verification</button>
      <button class="btn-stop hidden" id="btnStop">Stop</button>
      <span class="prog-text hidden" id="progText"></span>
    </div>
    <div class="prog-wrap hidden" id="progWrap">
      <div class="prog-fill" id="progFill" style="width:0%"></div>
    </div>
    <div class="log hidden" id="logBox"></div>
  </div>

  <!-- Results -->
  <div class="card-success hidden" id="resultsCard">
    <div class="card-title-green">‚úì Verification Complete</div>
    <div class="stats">
      <div><div class="stat-label">Total Checked</div><div class="stat-value" id="statTotal">0</div></div>
      <div><div class="stat-label">Verified Matches</div><div class="stat-value green" id="statMatches">0</div></div>
      <div><div class="stat-label">Match Rate</div><div class="stat-value" id="statRate">0%</div></div>
    </div>
    <button class="btn-dl" id="btnDownload">‚¨á&nbsp; Download Verified Matches CSV</button>
    <div style="margin-top:0.75rem;font-family:monospace;font-size:0.72rem;color:#6e7681">
      Adds columns: <span class="code-tag">_SDAT_Owner</span> <span class="code-tag">_SDAT_Address</span> <span class="code-tag">_Match_Type</span>
    </div>
  </div>

  <div class="footer">Data: Maryland Open Data ¬∑ SDAT Real Property (x8a5-h2sy) ¬∑ Updated Tue‚ÄìSat</div>
</div>

<script>
// Correct SDAT field names from the actual API schema:
// premsnum = premise street number
// premsnam = premise street name  
// premcity = premise city
// premzip  = premise zip
// ownname1 = owner name 1
// ownname2 = owner name 2

const ENDPOINT = "https://opendata.maryland.gov/resource/x8a5-h2sy.json";
let csvData = null;
let resultCSV = "";
let aborted = false;

function parseCSV(text) {
  const lines = text.trim().split("\n");
  if (lines.length < 2) return { headers: [], rows: [] };
  function splitRow(line) {
    const out = []; let cur = "", q = false;
    for (const ch of line) {
      if (ch === '"') { q = !q; continue; }
      if (ch === ',' && !q) { out.push(cur.trim()); cur = ""; continue; }
      cur += ch;
    }
    out.push(cur.trim());
    return out;
  }
  const headers = splitRow(lines[0]);
  const rows = lines.slice(1).filter(l => l.trim()).map(l => {
    const v = splitRow(l);
    return Object.fromEntries(headers.map((h, i) => [h, v[i] || ""]));
  });
  return { headers, rows };
}

function toCSVLine(headers, row) {
  return headers.map(h => '"' + (row[h] || "").replace(/"/g, '""') + '"').join(",");
}

function autoDetect(headers) {
  const h = headers.map(x => x.toLowerCase());
  const find = (...words) => {
    const idx = h.findIndex(c => words.some(w => c.includes(w)));
    return idx >= 0 ? headers[idx] : "";
  };
  return {
    name: find("decedent","deceased","name","owner"),
    addr: find("address","street","property"),
    city: find("city"),
    zip:  find("zip","postal"),
  };
}

function populateSelect(id, headers, selected, addBlank) {
  const el = document.getElementById(id);
  el.innerHTML = "";
  if (addBlank) {
    const o = document.createElement("option");
    o.value = ""; o.textContent = "‚Äî optional ‚Äî";
    el.appendChild(o);
  }
  headers.forEach(h => {
    const o = document.createElement("option");
    o.value = h; o.textContent = h;
    if (h === selected) o.selected = true;
    el.appendChild(o);
  });
}

// Extract last name: take the last significant word from a name string
// Handles "John Smith", "SMITH JOHN", "Smith, John", "John & Mary Smith"
function extractLastName(name) {
  const clean = name.toUpperCase().replace(/[^A-Z\s]/g, " ").trim();
  const tokens = clean.split(/\s+/).filter(t => t.length > 1);
  if (!tokens.length) return "";
  // If it looks like "LASTNAME FIRSTNAME" (all caps from SDAT style), return first token
  // We'll just return the longest token as a proxy for last name
  // Actually: return ALL tokens so we can check any of them
  return tokens;
}

// Match: returns true if ANY token from decedent name appears in owner name
// This handles "SMITH JOHN & MARY" matching "John Smith"
function nameMatch(decedent, owner) {
  if (!decedent || !owner) return false;
  const norm = s => s.toUpperCase().replace(/[^A-Z\s]/g, " ").trim();
  const decTokens = norm(decedent).split(/\s+/).filter(t => t.length > 2); // skip short tokens like "JR"
  const ownerNorm = norm(owner);
  // Match if the last name (longest token, or any token) is found in owner
  // Strategy: at least ONE token must match, and it must be a meaningful token
  // We sort by length descending so longest (most likely last name) is checked first
  const sorted = [...decTokens].sort((a,b) => b.length - a.length);
  return sorted.some(tok => ownerNorm.includes(tok));
}

async function lookupAddress(addrRaw, cityRaw, zipRaw) {
  // Parse "123 Main St" into number + street name
  const addr = (addrRaw || "").trim();
  const city = (cityRaw || "").trim();
  const zip  = (zipRaw  || "").trim().replace(/\D/g, "").slice(0, 5);

  const m = addr.match(/^(\d+)\s+(.+?)(?:\s*,.*)?$/);
  const streetNum  = m ? m[1] : "";
  const streetName = m ? m[2].trim() : addr.trim();

  // We need at least something useful
  if (!streetNum && !streetName && !zip) return null;

  // Build SoQL WHERE conditions using correct field names
  // Use simple equality for number, LIKE for street name (first word only for safety)
  const conds = [];

  if (streetNum) {
    conds.push("premsnum='" + streetNum + "'");
  }

  if (streetName) {
    // Use only the first word of the street name to avoid suffix mismatches (St vs Street)
    const firstWord = streetName.split(/\s+/)[0].toUpperCase()
      .replace(/[^A-Z0-9]/g, ""); // strip punctuation
    if (firstWord.length > 1) {
      conds.push("upper(premsnam) like '%" + firstWord + "%'");
    }
  }

  if (city) {
    const cityClean = city.toUpperCase().replace(/[^A-Z\s]/g, "").trim();
    conds.push("upper(premcity) like '%" + cityClean + "%'");
  }

  if (zip) {
    conds.push("premzip='" + zip + "'");
  }

  if (!conds.length) return null;

  // Build URL ‚Äî do NOT double-encode. The fetch URL needs % encoded normally.
  const where = conds.join(" AND ");
  const url = ENDPOINT + "?$limit=10&$where=" + encodeURIComponent(where);

  try {
    const r = await fetch(url);
    if (!r.ok) return null;
    const d = await r.json();
    return d.length ? d : null;
  } catch(e) {
    return null;
  }
}

function loadFile(file) {
  if (!file || !file.name.endsWith(".csv")) return;
  const reader = new FileReader();
  reader.onload = e => {
    csvData = parseCSV(e.target.result);
    document.getElementById("fileName").textContent = "üìÑ " + file.name;
    document.getElementById("recordCount").textContent = csvData.rows.length.toLocaleString() + " records loaded";
    document.getElementById("dropEmpty").classList.add("hidden");
    document.getElementById("dropLoaded").classList.remove("hidden");
    const d = autoDetect(csvData.headers);
    populateSelect("colName", csvData.headers, d.name, false);
    populateSelect("colAddr", csvData.headers, d.addr, true);
    populateSelect("colCity", csvData.headers, d.city, true);
    populateSelect("colZip",  csvData.headers, d.zip,  true);
    document.getElementById("mappingCard").classList.remove("hidden");
    document.getElementById("runCard").classList.remove("hidden");
    document.getElementById("resultsCard").classList.add("hidden");
    document.getElementById("logBox").innerHTML = "";
    document.getElementById("logBox").classList.add("hidden");
  };
  reader.readAsText(file);
}

const dz = document.getElementById("dropzone");
dz.addEventListener("click", () => document.getElementById("fileInput").click());
dz.addEventListener("dragover", e => { e.preventDefault(); dz.classList.add("active"); });
dz.addEventListener("dragleave", () => dz.classList.remove("active"));
dz.addEventListener("drop", e => { e.preventDefault(); dz.classList.remove("active"); loadFile(e.dataTransfer.files[0]); });
document.getElementById("fileInput").addEventListener("change", e => loadFile(e.target.files[0]));

function addLog(msg) {
  const box = document.getElementById("logBox");
  box.classList.remove("hidden");
  const line = document.createElement("div");
  line.textContent = msg;
  box.appendChild(line);
  box.scrollTop = box.scrollHeight;
}

document.getElementById("btnRun").addEventListener("click", async () => {
  if (!csvData) return;
  const nameCol = document.getElementById("colName").value;
  const addrCol = document.getElementById("colAddr").value;
  const cityCol = document.getElementById("colCity").value;
  const zipCol  = document.getElementById("colZip").value;
  if (!nameCol) { alert("Please select a Name column."); return; }

  aborted = false;
  const btnRun   = document.getElementById("btnRun");
  const btnStop  = document.getElementById("btnStop");
  const progWrap = document.getElementById("progWrap");
  const progFill = document.getElementById("progFill");
  const progText = document.getElementById("progText");
  const logBox   = document.getElementById("logBox");

  btnRun.disabled = true;
  btnRun.textContent = "Running‚Ä¶";
  btnStop.classList.remove("hidden");
  progWrap.classList.remove("hidden");
  progText.classList.remove("hidden");
  logBox.innerHTML = "";
  logBox.classList.add("hidden");
  document.getElementById("resultsCard").classList.add("hidden");

  const matches = [];
  const total = csvData.rows.length;

  for (let i = 0; i < total; i++) {
    if (aborted) { addLog("‚ö† Stopped by user at row " + (i+1)); break; }

    const row = csvData.rows[i];
    const name = (row[nameCol] || "").trim();
    const addr = addrCol ? (row[addrCol] || "").trim() : "";
    const city = cityCol ? (row[cityCol] || "").trim() : "";
    const zip  = zipCol  ? (row[zipCol]  || "").trim() : "";

    let matched = false;
    let matchType = "";
    let sdatOwner = "";
    let sdatAddr  = "";

    try {
      const records = await lookupAddress(addr, city, zip);

      if (records && records.length > 0) {
        // Try name match first
        for (const rec of records) {
          const o1 = (rec.ownname1 || "").trim();
          const o2 = (rec.ownname2 || "").trim();
          if (nameMatch(name, o1) || nameMatch(name, o2)) {
            matched   = true;
            matchType = "Name + Address";
            sdatOwner = [o1, o2].filter(Boolean).join(" / ");
            sdatAddr  = [rec.premsnum, rec.premsnam, rec.premcity, rec.premzip]
                          .filter(Boolean).join(" ").trim();
            break;
          }
        }
        if (!matched) {
          const owners = records.map(r => r.ownname1 || "?").join(", ");
          addLog("Row " + (i+1) + ': "' + name + '" ‚Äî property found but no name match (SDAT owners: ' + owners + ')');
        }
      } else {
        addLog("Row " + (i+1) + ': "' + name + '" @ ' + (addr||zip||"?") + ' ‚Äî no property record found');
      }
    } catch(err) {
      addLog("Row " + (i+1) + ": API error ‚Äî " + err.message);
    }

    if (matched) {
      matches.push({
        ...row,
        _SDAT_Owner:   sdatOwner,
        _SDAT_Address: sdatAddr,
        _Match_Type:   matchType
      });
    }

    // Update progress
    const pct = Math.round(((i+1)/total)*100);
    progFill.style.width = pct + "%";
    progText.innerHTML = pct + "% &nbsp;¬∑&nbsp; <span style='color:#3fb950'>" + matches.length + " matches</span>";

    await new Promise(r => setTimeout(r, 100));
  }

  // Build output CSV
  const outHeaders = [...csvData.headers, "_SDAT_Owner", "_SDAT_Address", "_Match_Type"];
  const lines = [outHeaders.join(","), ...matches.map(r => toCSVLine(outHeaders, r))];
  resultCSV = lines.join("\n");

  document.getElementById("statTotal").textContent   = total.toLocaleString();
  document.getElementById("statMatches").textContent = matches.length.toLocaleString();
  document.getElementById("statRate").textContent    = total ? Math.round((matches.length/total)*100) + "%" : "0%";

  btnRun.disabled = false;
  btnRun.textContent = "‚ñ∂  Run Verification";
  btnStop.classList.add("hidden");
  document.getElementById("resultsCard").classList.remove("hidden");
});

document.getElementById("btnStop").addEventListener("click", () => { aborted = true; });

document.getElementById("btnDownload").addEventListener("click", () => {
  const blob = new Blob([resultCSV], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "verified_matches_" + new Date().toISOString().slice(0,10) + ".csv";
  a.click();
});
</script>
</body>
</html>
