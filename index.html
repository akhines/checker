import { useState, useCallback, useRef } from "react";

const SOCRATA_ENDPOINT = "https://opendata.maryland.gov/resource/x8a5-h2sy.json";

function nameFuzzyMatch(decedentName, ownerName) {
  if (!decedentName || !ownerName) return false;
  const normalize = (s) => s.toUpperCase().replace(/[^A-Z\s]/g, "").trim();
  const decTokens = normalize(decedentName).split(/\s+/).filter(t => t.length > 1);
  const ownerNorm = normalize(ownerName);
  return decTokens.every(tok => ownerNorm.includes(tok));
}

async function lookupProperty(row) {
  let parsedNum = "";
  let parsedStreet = "";

  const combined = (row.address || "").toString().trim();
  if (combined) {
    const match = combined.match(/^(\d+)\s+(.+?)(?:,.*)?$/);
    if (match) {
      parsedNum = match[1];
      parsedStreet = match[2].toUpperCase().trim();
    }
  }

  const premiseCity = (row.city || "").toString().trim().toUpperCase();
  const zipCode = (row.zip || "").toString().trim().replace(/\D/g, "").substring(0, 5);

  if (!parsedNum && !parsedStreet && !zipCode) return null;

  const conditions = [];
  if (parsedNum) conditions.push(`premise_address_number='${parsedNum}'`);
  if (parsedStreet) {
    const firstWord = encodeURIComponent(parsedStreet.split(" ")[0]);
    conditions.push(`upper(premise_street_name) like '%25${firstWord}%25'`);
  }
  if (premiseCity) conditions.push(`upper(premise_city) like '%25${encodeURIComponent(premiseCity)}%25'`);
  if (zipCode) conditions.push(`premise_zip_code='${zipCode}'`);

  const url = `${SOCRATA_ENDPOINT}?$limit=5&$where=${conditions.join(" AND ")}`;

  try {
    const res = await fetch(url);
    if (!res.ok) return null;
    const data = await res.json();
    return data.length > 0 ? data : null;
  } catch {
    return null;
  }
}

function detectColumns(headers) {
  const h = headers.map(x => x.toLowerCase().replace(/[^a-z0-9]/g, "_"));
  const find = (candidates) => headers[h.findIndex(col => candidates.some(c => col.includes(c)))] || null;
  return {
    decedentCol: find(["decedent", "deceased", "name", "owner"]),
    addressCol: find(["address", "street", "property"]),
    zipCol: find(["zip", "postal"]),
    cityCol: find(["city"]),
  };
}

function parseCSV(text) {
  const lines = text.trim().split("\n");
  if (lines.length < 2) return { headers: [], rows: [] };
  const parseRow = (line) => {
    const result = [];
    let cur = "", inQuote = false;
    for (let i = 0; i < line.length; i++) {
      if (line[i] === '"') { inQuote = !inQuote; continue; }
      if (line[i] === "," && !inQuote) { result.push(cur.trim()); cur = ""; continue; }
      cur += line[i];
    }
    result.push(cur.trim());
    return result;
  };
  const headers = parseRow(lines[0]);
  const rows = lines.slice(1).filter(l => l.trim()).map(line => {
    const vals = parseRow(line);
    return Object.fromEntries(headers.map((h, i) => [h, vals[i] || ""]));
  });
  return { headers, rows };
}

function rowToCSVLine(headers, row) {
  return headers.map(h => `"${(row[h] || "").toString().replace(/"/g, '""')}"`).join(",");
}

export default function App() {
  const [file, setFile] = useState(null);
  const [csvData, setCsvData] = useState(null);
  const [decedentCol, setDecedentCol] = useState("");
  const [addrCol, setAddrCol] = useState("");
  const [cityCol, setCityCol] = useState("");
  const [zipCol, setZipCol] = useState("");
  const [running, setRunning] = useState(false);
  const [progress, setProgress] = useState({ done: 0, total: 0 });
  const [matchCount, setMatchCount] = useState(0);
  const [results, setResults] = useState(null);
  const [dragging, setDragging] = useState(false);
  const [log, setLog] = useState([]);
  const abortRef = useRef(false);

  const handleFile = useCallback((f) => {
    if (!f || !f.name.endsWith(".csv")) return;
    setFile(f);
    setResults(null);
    setLog([]);
    setProgress({ done: 0, total: 0 });
    setMatchCount(0);
    const reader = new FileReader();
    reader.onload = (e) => {
      const parsed = parseCSV(e.target.result);
      setCsvData(parsed);
      const d = detectColumns(parsed.headers);
      setDecedentCol(d.decedentCol || parsed.headers[0] || "");
      setAddrCol(d.addressCol || "");
      setZipCol(d.zipCol || "");
      setCityCol(d.cityCol || "");
    };
    reader.readAsText(f);
  }, []);

  const handleDrop = useCallback((e) => {
    e.preventDefault();
    setDragging(false);
    handleFile(e.dataTransfer.files[0]);
  }, [handleFile]);

  const handleRun = async () => {
    if (!csvData || !decedentCol) return;
    setRunning(true);
    setResults(null);
    setLog([]);
    setMatchCount(0);
    abortRef.current = false;
    const matches = [];
    const total = csvData.rows.length;
    setProgress({ done: 0, total });

    for (let i = 0; i < csvData.rows.length; i++) {
      if (abortRef.current) break;
      const row = csvData.rows[i];
      const decedent = row[decedentCol] || "";
      const lookupRow = {
        address: row[addrCol] || "",
        city: row[cityCol] || "",
        zip: row[zipCol] || "",
      };

      let matched = false;
      let ownerFound = "";
      let addrFound = "";

      try {
        const records = await lookupProperty(lookupRow);
        if (records && records.length > 0) {
          for (const rec of records) {
            const o1 = rec.owner_name_1 || "";
            const o2 = rec.owner_name_2 || "";
            if (nameFuzzyMatch(decedent, o1) || nameFuzzyMatch(decedent, o2)) {
              matched = true;
              ownerFound = [o1, o2].filter(Boolean).join(" / ");
              addrFound = `${rec.premise_address_number || ""} ${rec.premise_street_name || ""}, ${rec.premise_city || ""} ${rec.premise_zip_code || ""}`.trim();
              break;
            }
          }
          if (!matched) {
            setLog(l => [...l, `Row ${i + 1}: "${decedent}" ‚Äî address found, name mismatch (SDAT: ${records[0].owner_name_1 || "?"})`]);
          }
        } else {
          setLog(l => [...l, `Row ${i + 1}: "${decedent}" ‚Äî no property record found`]);
        }
      } catch {
        setLog(l => [...l, `Row ${i + 1}: API error`]);
      }

      if (matched) {
        matches.push({ ...row, _Verified_Owner: ownerFound, _Verified_Address: addrFound, _Status: "MATCH" });
        setMatchCount(matches.length);
      }

      setProgress({ done: i + 1, total });
      await new Promise(r => setTimeout(r, 120));
    }

    const outHeaders = [...csvData.headers, "_Verified_Owner", "_Verified_Address", "_Status"];
    const csvLines = [outHeaders.join(","), ...matches.map(r => rowToCSVLine(outHeaders, r))];
    setResults({ csv: csvLines.join("\n"), count: matches.length, total: csvData.rows.length });
    setRunning(false);
  };

  const downloadCSV = () => {
    if (!results) return;
    const blob = new Blob([results.csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `verified_matches_${new Date().toISOString().slice(0, 10)}.csv`;
    a.click();
  };

  const pct = progress.total ? Math.round((progress.done / progress.total) * 100) : 0;

  const css = `
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #0d1117; }
    .page { min-height: 100vh; background: #0d1117; color: #e6edf3; font-family: Georgia, serif; padding: 2rem 1rem; }
    .wrap { max-width: 740px; margin: 0 auto; }
    .eyebrow { font-family: monospace; font-size: 0.7rem; color: #3fb950; letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #238636; display: inline-block; }
    h1 { font-size: 1.75rem; font-weight: 700; color: #e6edf3; margin-bottom: 0.25rem; }
    .sub { font-style: italic; color: #8b949e; font-size: 0.92rem; margin-bottom: 2rem; }
    .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.25rem; }
    .card-green { background: #161b22; border: 1px solid #238636; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.25rem; }
    .sec-title { font-size: 0.95rem; color: #58a6ff; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #21262d; }
    .sec-title-green { font-size: 0.95rem; color: #3fb950; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #21262d; }
    .lbl { font-family: monospace; font-size: 0.69rem; text-transform: uppercase; letter-spacing: 0.1em; color: #8b949e; margin-bottom: 0.3rem; }
    .hint { font-family: monospace; font-size: 0.71rem; color: #6e7681; margin-top: 0.2rem; margin-bottom: 0.9rem; }
    select { background: #0d1117; border: 1px solid #30363d; color: #e6edf3; border-radius: 4px; padding: 0.45rem 0.7rem; font-size: 0.85rem; width: 100%; font-family: monospace; outline: none; }
    select:focus { border-color: #58a6ff; }
    .drop { border: 2px dashed #30363d; border-radius: 8px; padding: 2.5rem 2rem; text-align: center; cursor: pointer; transition: all 0.2s; }
    .drop:hover, .drop.active { border-color: #58a6ff; background: rgba(88,166,255,0.04); }
    .badge { display: inline-block; background: #1a3d22; color: #3fb950; border-radius: 12px; padding: 0.2rem 0.65rem; font-family: monospace; font-size: 0.75rem; font-weight: 600; }
    .btn-run { background: #238636; color: #fff; border: none; border-radius: 6px; padding: 0.65rem 1.4rem; font-family: monospace; font-size: 0.85rem; font-weight: 600; cursor: pointer; letter-spacing: 0.04em; }
    .btn-run:disabled { background: #1a3d22; color: #4d7a55; cursor: not-allowed; }
    .btn-run:not(:disabled):hover { background: #2ea043; }
    .btn-stop { background: #da3633; color: #fff; border: none; border-radius: 6px; padding: 0.45rem 0.9rem; font-family: monospace; font-size: 0.78rem; cursor: pointer; }
    .btn-dl { background: #1f6feb; color: #fff; border: none; border-radius: 6px; padding: 0.65rem 1.4rem; font-family: monospace; font-size: 0.85rem; font-weight: 600; cursor: pointer; }
    .btn-dl:hover { background: #388bfd; }
    .prog-bar { height: 5px; background: #21262d; border-radius: 3px; overflow: hidden; margin-top: 0.75rem; }
    .prog-fill { height: 100%; background: linear-gradient(90deg,#238636,#2ea043); border-radius: 3px; transition: width 0.3s; }
    .log { background: #0d1117; border: 1px solid #21262d; border-radius: 4px; padding: 0.6rem 0.75rem; max-height: 130px; overflow-y: auto; font-family: monospace; font-size: 0.72rem; color: #8b949e; margin-top: 0.75rem; }
    .stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 1.25rem; }
    .stat-lbl { font-family: monospace; font-size: 0.69rem; text-transform: uppercase; letter-spacing: 0.1em; color: #8b949e; margin-bottom: 0.2rem; }
    .stat-val { font-size: 1.8rem; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .tag { display: inline-block; background: #21262d; color: #8b949e; border-radius: 4px; padding: 0.1rem 0.45rem; font-family: monospace; font-size: 0.7rem; margin-right: 4px; }
    .row-btns { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
    .pct-text { font-family: monospace; font-size: 0.82rem; color: #8b949e; }
    .footer { text-align: center; font-family: monospace; font-size: 0.7rem; color: #4d7a55; margin-top: 2rem; }
  `;

  return (
    <div className="page">
      <style>{css}</style>
      <div className="wrap">

        <div className="eyebrow"><span className="dot"></span>Maryland SDAT ¬∑ Public Records</div>
        <h1>Homeowner Verification</h1>
        <p className="sub">Cross-reference your prospect list against Maryland property records</p>

        {/* Upload */}
        <div className="card">
          <div className="sec-title">‚ë† Upload Your CSV</div>
          <div
            className={`drop${dragging ? " active" : ""}`}
            onDragOver={(e) => { e.preventDefault(); setDragging(true); }}
            onDragLeave={() => setDragging(false)}
            onDrop={handleDrop}
            onClick={() => document.getElementById("csv-file").click()}
          >
            <input id="csv-file" type="file" accept=".csv" style={{ display: "none" }} onChange={e => handleFile(e.target.files[0])} />
            {file ? (
              <div>
                <div style={{ fontFamily: "monospace", marginBottom: "0.4rem" }}>üìÑ {file.name}</div>
                <span className="badge">{csvData?.rows.length.toLocaleString()} records loaded</span>
              </div>
            ) : (
              <div>
                <div style={{ fontSize: "2rem", marginBottom: "0.5rem" }}>‚¨ÜÔ∏è</div>
                <div style={{ color: "#8b949e", fontSize: "0.9rem" }}>Drop your CSV here, or click to browse</div>
              </div>
            )}
          </div>
        </div>

        {/* Column Mapping */}
        {csvData && (
          <div className="card">
            <div className="sec-title">‚ë° Map Your Columns</div>

            <div className="lbl">Decedent / Owner Name Column *</div>
            <select value={decedentCol} onChange={e => setDecedentCol(e.target.value)}>
              {csvData.headers.map(h => <option key={h}>{h}</option>)}
            </select>
            <div className="hint">The name to match against SDAT owner records</div>

            <div className="grid2">
              <div>
                <div className="lbl">Property Address Column *</div>
                <select value={addrCol} onChange={e => setAddrCol(e.target.value)}>
                  <option value="">‚Äî select ‚Äî</option>
                  {csvData.headers.map(h => <option key={h}>{h}</option>)}
                </select>
                <div className="hint">e.g. "123 Main St"</div>
              </div>
              <div>
                <div className="lbl">City Column</div>
                <select value={cityCol} onChange={e => setCityCol(e.target.value)}>
                  <option value="">‚Äî optional ‚Äî</option>
                  {csvData.headers.map(h => <option key={h}>{h}</option>)}
                </select>
                <div className="hint">Improves match accuracy</div>
              </div>
            </div>

            <div style={{ maxWidth: 300 }}>
              <div className="lbl">ZIP Code Column</div>
              <select value={zipCol} onChange={e => setZipCol(e.target.value)}>
                <option value="">‚Äî optional but recommended ‚Äî</option>
                {csvData.headers.map(h => <option key={h}>{h}</option>)}
              </select>
            </div>
          </div>
        )}

        {/* Run */}
        {csvData && (
          <div className="card">
            <div className="sec-title">‚ë¢ Verify Against SDAT</div>
            <div className="row-btns">
              <button className="btn-run" disabled={running || !decedentCol} onClick={handleRun}>
                {running ? `Checking‚Ä¶ ${progress.done} / ${progress.total}` : "‚ñ∂  Run Verification"}
              </button>
              {running && (
                <button className="btn-stop" onClick={() => { abortRef.current = true; }}>Stop</button>
              )}
              {progress.total > 0 && (
                <span className="pct-text">
                  {pct}% &nbsp;¬∑&nbsp; <span style={{ color: "#3fb950" }}>{matchCount} matches</span>
                </span>
              )}
            </div>

            {running && (
              <div className="prog-bar">
                <div className="prog-fill" style={{ width: `${pct}%` }}></div>
              </div>
            )}

            {log.length > 0 && (
              <div className="log">
                {log.slice(-80).map((entry, i) => <div key={i}>{entry}</div>)}
              </div>
            )}
          </div>
        )}

        {/* Results */}
        {results && (
          <div className="card-green">
            <div className="sec-title-green">‚úì Verification Complete</div>
            <div className="stats">
              <div>
                <div className="stat-lbl">Total Checked</div>
                <div className="stat-val">{progress.done.toLocaleString()}</div>
              </div>
              <div>
                <div className="stat-lbl">Verified Matches</div>
                <div className="stat-val" style={{ color: "#3fb950" }}>{results.count.toLocaleString()}</div>
              </div>
              <div>
                <div className="stat-lbl">Match Rate</div>
                <div className="stat-val">
                  {progress.done ? Math.round((results.count / progress.done) * 100) : 0}%
                </div>
              </div>
            </div>
            <button className="btn-dl" onClick={downloadCSV}>‚¨á  Download Verified Matches CSV</button>
            <div style={{ marginTop: "0.75rem", fontFamily: "monospace", fontSize: "0.72rem", color: "#6e7681" }}>
              Output adds: <span className="tag">_Verified_Owner</span><span className="tag">_Verified_Address</span><span className="tag">_Status</span>
            </div>
          </div>
        )}

        <div className="footer">Data sourced from Maryland Open Data ¬∑ SDAT Real Property Assessments ¬∑ Updated Tuesday‚ÄìSaturday</div>
      </div>
    </div>
  );
}
