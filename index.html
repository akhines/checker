<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MD Homeowner Verification</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #0d1117; color: #e6edf3; font-family: Georgia, serif; min-height: 100vh; padding: 2rem 1rem; }
  .wrap { max-width: 700px; margin: 0 auto; }
  .eyebrow { display: flex; align-items: center; gap: 8px; font-family: monospace; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.12em; color: #3fb950; margin-bottom: 0.5rem; }
  .dot { width: 8px; height: 8px; border-radius: 50%; background: #238636; flex-shrink: 0; }
  h1 { font-size: 1.9rem; font-weight: 700; color: #fff; margin-bottom: 0.25rem; }
  .subtitle { color: #8b949e; font-size: 0.9rem; font-style: italic; margin-bottom: 2rem; }
  .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.25rem; }
  .card-success { background: #161b22; border: 1px solid #238636; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.25rem; }
  .card-title { font-family: monospace; font-size: 0.85rem; color: #58a6ff; border-bottom: 1px solid #21262d; padding-bottom: 0.6rem; margin-bottom: 1.25rem; }
  .card-title-green { font-family: monospace; font-size: 0.85rem; color: #3fb950; border-bottom: 1px solid #21262d; padding-bottom: 0.6rem; margin-bottom: 1.25rem; }
  .dropzone { border: 2px dashed #30363d; border-radius: 8px; padding: 2.5rem; text-align: center; cursor: pointer; transition: border-color 0.2s, background 0.2s; }
  .dropzone:hover, .dropzone.active { border-color: #58a6ff; background: rgba(88,166,255,0.04); }
  .badge { display: inline-block; background: #1a3d22; color: #3fb950; border-radius: 20px; padding: 0.2rem 0.75rem; font-family: monospace; font-size: 0.75rem; font-weight: 600; margin-top: 0.4rem; }
  .field { margin-bottom: 1rem; }
  .field label { display: block; font-family: monospace; font-size: 0.69rem; text-transform: uppercase; letter-spacing: 0.1em; color: #8b949e; margin-bottom: 0.3rem; }
  .field .hint { font-family: monospace; font-size: 0.71rem; color: #6e7681; margin-top: 0.2rem; }
  select { width: 100%; background: #0d1117; border: 1px solid #30363d; color: #e6edf3; border-radius: 4px; padding: 0.45rem 0.7rem; font-size: 0.85rem; font-family: monospace; outline: none; }
  select:focus { border-color: #58a6ff; }
  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  .btn-run { background: #238636; color: #fff; border: none; border-radius: 6px; padding: 0.6rem 1.4rem; font-family: monospace; font-size: 0.85rem; font-weight: 700; cursor: pointer; transition: background 0.15s; }
  .btn-run:hover:not(:disabled) { background: #2ea043; }
  .btn-run:disabled { background: #1a3d22; color: #4d7a55; cursor: not-allowed; }
  .btn-stop { background: #da3633; color: #fff; border: none; border-radius: 6px; padding: 0.45rem 0.9rem; font-family: monospace; font-size: 0.78rem; cursor: pointer; }
  .btn-dl { background: #1f6feb; color: #fff; border: none; border-radius: 6px; padding: 0.6rem 1.4rem; font-family: monospace; font-size: 0.85rem; font-weight: 700; cursor: pointer; margin-right: 0.5rem; margin-bottom: 0.5rem; }
  .btn-dl:hover { background: #388bfd; }
  .btn-row { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
  .prog-wrap { margin-top: 0.75rem; background: #21262d; border-radius: 3px; height: 5px; overflow: hidden; }
  .prog-fill { height: 100%; background: linear-gradient(90deg, #238636, #2ea043); border-radius: 3px; transition: width 0.3s; }
  .prog-text { font-family: monospace; font-size: 0.82rem; color: #8b949e; }
  .log { background: #0d1117; border: 1px solid #21262d; border-radius: 4px; padding: 0.6rem 0.75rem; max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.72rem; color: #8b949e; margin-top: 0.75rem; }
  .stats { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem; }
  .stat-label { font-family: monospace; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: #8b949e; margin-bottom: 0.2rem; }
  .stat-value { font-size: 1.7rem; font-weight: 700; }
  .green { color: #3fb950; }
  .orange { color: #f0883e; }
  .code-tag { background: #21262d; color: #8b949e; border-radius: 3px; padding: 0.1rem 0.4rem; font-family: monospace; font-size: 0.72rem; }
  .info-box { background: #1c2128; border: 1px solid #30363d; border-radius: 4px; padding: 0.65rem 0.85rem; font-family: monospace; font-size: 0.75rem; color: #8b949e; margin-bottom: 1rem; line-height: 1.6; }
  .preview-box { background: #0d1117; border: 1px solid #21262d; border-radius: 4px; padding: 0.6rem 0.75rem; font-family: monospace; font-size: 0.72rem; color: #58a6ff; margin-top: 0.5rem; }
  .tab-legend { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
  .tab-pill { display: inline-flex; align-items: center; gap: 0.4rem; background: #21262d; border-radius: 4px; padding: 0.3rem 0.7rem; font-family: monospace; font-size: 0.75rem; }
  .tab-pill .swatch { width: 10px; height: 10px; border-radius: 2px; }
  .footer { text-align: center; font-family: monospace; font-size: 0.7rem; color: #4d7a55; margin-top: 2rem; }
  .hidden { display: none; }
</style>
</head>
<body>
<div class="wrap">

  <div class="eyebrow"><span class="dot"></span>Maryland SDAT ¬∑ Public Records</div>
  <h1>Homeowner Verification</h1>
  <p class="subtitle">Outputs a two-tab Excel file ‚Äî verified matches + non-matches</p>

  <!-- Step 1 -->
  <div class="card">
    <div class="card-title">‚ë† Upload Your CSV</div>
    <div class="dropzone" id="dropzone">
      <input type="file" accept=".csv" id="fileInput" class="hidden"/>
      <div id="dropEmpty">
        <div style="font-size:2rem;margin-bottom:0.5rem">‚¨ÜÔ∏è</div>
        <div style="color:#8b949e;font-size:0.9rem">Drop your CSV here, or click to browse</div>
      </div>
      <div id="dropLoaded" class="hidden">
        <div style="font-family:monospace;margin-bottom:0.4rem" id="fileName"></div>
        <span class="badge" id="recordCount"></span>
      </div>
    </div>
  </div>

  <!-- Step 2 -->
  <div class="card hidden" id="mappingCard">
    <div class="card-title">‚ë° Confirm Column Mapping</div>
    <div class="info-box" id="detectedInfo"></div>
    <div class="grid2">
      <div class="field">
        <label>Decedent Name Column *</label>
        <select id="colName"></select>
        <div class="hint">Last name matched against SDAT owner</div>
      </div>
      <div class="field">
        <label>Property Address Column *</label>
        <select id="colAddr"></select>
        <div class="hint">e.g. "974 Morgan Run Rd, Baltimore, MD"</div>
      </div>
    </div>
    <div class="grid2">
      <div class="field">
        <label>ZIP Code Column</label>
        <select id="colZip"></select>
        <div class="hint">Leave blank if ZIP is inside address</div>
      </div>
      <div class="field">
        <label>City Column</label>
        <select id="colCity"></select>
        <div class="hint">Leave blank if city is inside address</div>
      </div>
    </div>
    <div id="addrPreview" class="preview-box hidden"></div>
  </div>

  <!-- Step 3 -->
  <div class="card hidden" id="runCard">
    <div class="card-title">‚ë¢ Verify Against SDAT</div>
    <div class="btn-row">
      <button class="btn-run" id="btnRun">‚ñ∂&nbsp; Run Verification</button>
      <button class="btn-stop hidden" id="btnStop">Stop</button>
      <span class="prog-text hidden" id="progText"></span>
    </div>
    <div class="prog-wrap hidden" id="progWrap">
      <div class="prog-fill" id="progFill" style="width:0%"></div>
    </div>
    <div class="log hidden" id="logBox"></div>
  </div>

  <!-- Results -->
  <div class="card-success hidden" id="resultsCard">
    <div class="card-title-green">‚úì Verification Complete</div>
    <div class="stats">
      <div><div class="stat-label">Checked</div><div class="stat-value" id="statTotal">0</div></div>
      <div><div class="stat-label">Matches</div><div class="stat-value green" id="statMatches">0</div></div>
      <div><div class="stat-label">No Match</div><div class="stat-value orange" id="statNone">0</div></div>
      <div><div class="stat-label">Match Rate</div><div class="stat-value" id="statRate">0%</div></div>
    </div>

    <div class="tab-legend">
      <div class="tab-pill"><span class="swatch" style="background:#238636"></span>Tab 1: Verified Matches</div>
      <div class="tab-pill"><span class="swatch" style="background:#f0883e"></span>Tab 2: No Match / Not Found</div>
    </div>

    <button class="btn-dl" id="btnDownload">‚¨á&nbsp; Download Excel (.xlsx)</button>
    <div style="margin-top:0.75rem;font-family:monospace;font-size:0.72rem;color:#6e7681">
      Matches tab adds: <span class="code-tag">_SDAT_Owner</span> <span class="code-tag">_SDAT_Address</span> <span class="code-tag">_Match_Type</span><br/>
      No-match tab adds: <span class="code-tag">_No_Match_Reason</span>
    </div>
  </div>

  <div class="footer">Data: Maryland Open Data ¬∑ SDAT Real Property (x8a5-h2sy) ¬∑ Updated Tue‚ÄìSat</div>
</div>

<script>
const ENDPOINT = "https://opendata.maryland.gov/resource/x8a5-h2sy.json";
let csvData = null;
let matchRows = [], noMatchRows = [];
let aborted = false;

// --- CSV Parser ---
function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  if (lines.length < 2) return { headers: [], rows: [] };
  function splitRow(line) {
    const out = []; let cur = "", q = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') { if (q && line[i+1]==='"') { cur+='"'; i++; } else { q=!q; } continue; }
      if (ch === ',' && !q) { out.push(cur.trim()); cur=""; continue; }
      cur += ch;
    }
    out.push(cur.trim());
    return out;
  }
  const headers = splitRow(lines[0]);
  const rows = lines.slice(1).filter(l => l.trim()).map(l => {
    const v = splitRow(l);
    return Object.fromEntries(headers.map((h,i) => [h, v[i] !== undefined ? v[i] : ""]));
  });
  return { headers, rows };
}

// --- Auto detect columns ---
function autoDetect(headers) {
  const h = headers.map(x => x.toLowerCase());
  const find = (...words) => { const idx = h.findIndex(c => words.some(w => c.includes(w))); return idx >= 0 ? headers[idx] : ""; };
  return {
    name: find("decedent full","decedent","deceased","full name"),
    addr: find("decedent address","property address","address"),
    zip:  find("decedent zip","zip","postal"),
    city: find("decedent city","city"),
  };
}

function populateSelect(id, headers, selected, addBlank) {
  const el = document.getElementById(id);
  el.innerHTML = "";
  if (addBlank) { const o = document.createElement("option"); o.value=""; o.textContent="‚Äî not used ‚Äî"; el.appendChild(o); }
  headers.forEach(h => { const o = document.createElement("option"); o.value=h; o.textContent=h; if(h===selected) o.selected=true; el.appendChild(o); });
}

// --- Address parser: "974 Morgan Run Rd, Baltimore, MD" -> {num, street, city} ---
function parseAddr(raw) {
  const s = (raw||"").trim();
  const parts = s.split(",").map(p => p.trim());
  const streetPart = parts[0] || "";
  let city = (parts[1] || "").replace(/\s*[A-Z]{2}\s*$/, "").trim();
  const m = streetPart.match(/^(\d+[A-Z]?)\s+(.+)$/i);
  return { num: m ? m[1] : "", street: m ? m[2].trim() : streetPart, city };
}

// --- Name match: any significant token from decedent found in owner ---
function nameMatch(decedent, owner) {
  if (!decedent || !owner) return false;
  const norm = s => s.toUpperCase().replace(/[^A-Z\s]/g," ").replace(/\s+/g," ").trim();
  const skip = new Set(["JR","SR","II","III","IV","AND","THE","EST","TR","MR","MRS","MS"]);
  const tokens = norm(decedent).split(" ").filter(t => t.length > 2 && !skip.has(t));
  const ownerNorm = norm(owner);
  return [...tokens].sort((a,b) => b.length-a.length).some(tok => ownerNorm.includes(tok));
}

// --- SDAT lookup ---
async function lookupSDAT(addrRaw, cityOverride, zipOverride) {
  const { num, street, city: cityFromAddr } = parseAddr(addrRaw);
  const city = (cityOverride || cityFromAddr || "").toUpperCase().replace(/[^A-Z\s]/g,"").trim();
  const zip  = (zipOverride||"").replace(/\D/g,"").slice(0,5);

  const conds = [];
  if (num)    conds.push(`premsnum='${num}'`);
  if (street) {
    const fw = street.split(/\s+/)[0].toUpperCase().replace(/[^A-Z0-9]/g,"");
    if (fw.length > 1) conds.push(`upper(premsnam) like '%${fw}%'`);
  }
  if (city) {
    const cw = city.split(/\s+/)[0];
    if (cw.length > 2) conds.push(`upper(premcity) like '%${cw}%'`);
  }
  if (zip) conds.push(`premzip='${zip}'`);
  if (!conds.length) return { records: null, error: "insufficient address data" };

  const url = ENDPOINT + "?$limit=10&$where=" + encodeURIComponent(conds.join(" AND "));
  try {
    const r = await fetch(url);
    if (!r.ok) return { records: null, error: "API error " + r.status };
    const d = await r.json();
    return { records: d.length ? d : null, error: null };
  } catch(e) {
    return { records: null, error: e.message };
  }
}

// --- File load ---
function loadFile(file) {
  if (!file || !file.name.endsWith(".csv")) return;
  const reader = new FileReader();
  reader.onload = e => {
    csvData = parseCSV(e.target.result);
    document.getElementById("fileName").textContent = "üìÑ " + file.name;
    document.getElementById("recordCount").textContent = csvData.rows.length.toLocaleString() + " records loaded";
    document.getElementById("dropEmpty").classList.add("hidden");
    document.getElementById("dropLoaded").classList.remove("hidden");

    const d = autoDetect(csvData.headers);
    populateSelect("colName", csvData.headers, d.name, false);
    populateSelect("colAddr", csvData.headers, d.addr, false);
    populateSelect("colZip",  csvData.headers, d.zip,  true);
    populateSelect("colCity", csvData.headers, d.city, true);

    document.getElementById("detectedInfo").innerHTML =
      `Auto-detected &nbsp;‚Üí&nbsp; <strong style="color:#e6edf3">Name:</strong> ${d.name||"?"} &nbsp;|&nbsp; ` +
      `<strong style="color:#e6edf3">Address:</strong> ${d.addr||"?"} &nbsp;|&nbsp; ` +
      `<strong style="color:#e6edf3">ZIP:</strong> ${d.zip||"embedded"} &nbsp;|&nbsp; ` +
      `<strong style="color:#e6edf3">City:</strong> ${d.city||"embedded"}`;

    const sample = csvData.rows.find(r => r[d.addr]);
    if (sample) {
      const p = parseAddr(sample[d.addr]);
      document.getElementById("addrPreview").textContent =
        `Address parse preview: "${sample[d.addr]}" ‚Üí num="${p.num}" street="${p.street}" city="${p.city}"`;
      document.getElementById("addrPreview").classList.remove("hidden");
    }

    document.getElementById("mappingCard").classList.remove("hidden");
    document.getElementById("runCard").classList.remove("hidden");
    document.getElementById("resultsCard").classList.add("hidden");
    document.getElementById("logBox").innerHTML = "";
    document.getElementById("logBox").classList.add("hidden");
  };
  reader.readAsText(file);
}

const dz = document.getElementById("dropzone");
dz.addEventListener("click", () => document.getElementById("fileInput").click());
dz.addEventListener("dragover", e => { e.preventDefault(); dz.classList.add("active"); });
dz.addEventListener("dragleave", () => dz.classList.remove("active"));
dz.addEventListener("drop", e => { e.preventDefault(); dz.classList.remove("active"); loadFile(e.dataTransfer.files[0]); });
document.getElementById("fileInput").addEventListener("change", e => loadFile(e.target.files[0]));

function addLog(msg) {
  const box = document.getElementById("logBox");
  box.classList.remove("hidden");
  const line = document.createElement("div");
  line.textContent = msg;
  box.appendChild(line);
  if (box.children.length > 300) box.removeChild(box.firstChild);
  box.scrollTop = box.scrollHeight;
}

// --- Run ---
document.getElementById("btnRun").addEventListener("click", async () => {
  if (!csvData) return;
  const nameCol = document.getElementById("colName").value;
  const addrCol = document.getElementById("colAddr").value;
  const zipCol  = document.getElementById("colZip").value;
  const cityCol = document.getElementById("colCity").value;
  if (!nameCol || !addrCol) { alert("Please select Name and Address columns."); return; }

  aborted = false;
  matchRows = []; noMatchRows = [];
  const btnRun = document.getElementById("btnRun");
  btnRun.disabled = true; btnRun.textContent = "Running‚Ä¶";
  document.getElementById("btnStop").classList.remove("hidden");
  document.getElementById("progWrap").classList.remove("hidden");
  document.getElementById("progText").classList.remove("hidden");
  document.getElementById("logBox").innerHTML = "";
  document.getElementById("logBox").classList.remove("hidden");
  document.getElementById("resultsCard").classList.add("hidden");

  const total = csvData.rows.length;

  for (let i = 0; i < total; i++) {
    if (aborted) { addLog("‚ö† Stopped at row " + (i+1)); break; }

    const row     = csvData.rows[i];
    const name    = (row[nameCol]||"").trim();
    const addrRaw = (row[addrCol]||"").trim();
    const zipRaw  = zipCol  ? (row[zipCol] ||"").trim() : "";
    const cityRaw = cityCol ? (row[cityCol]||"").trim() : "";

    let matched = false, sdatOwner = "", sdatAddr = "", reason = "";

    const { records, error } = await lookupSDAT(addrRaw, cityRaw, zipRaw);

    if (error && !records) {
      reason = "Lookup error: " + error;
      addLog(`Row ${i+1}: "${name}" ‚Äî ${reason}`);
    } else if (records) {
      for (const rec of records) {
        const o1 = (rec.ownname1||"").trim(), o2 = (rec.ownname2||"").trim();
        if (nameMatch(name, o1) || nameMatch(name, o2)) {
          matched   = true;
          sdatOwner = [o1,o2].filter(Boolean).join(" / ");
          sdatAddr  = [rec.premsnum, rec.premsnam, rec.premcity, rec.premzip].filter(Boolean).join(" ");
          break;
        }
      }
      if (!matched) {
        const owners = records.slice(0,3).map(r => r.ownname1||"?").join(", ");
        reason = "Property found, name mismatch (SDAT: " + owners + ")";
        addLog(`Row ${i+1}: "${name}" ‚Äî ${reason}`);
      }
    } else {
      reason = "No property record found";
      addLog(`Row ${i+1}: "${name}" @ ${addrRaw} ‚Äî ${reason}`);
    }

    const outRow = Object.assign({}, row);
    if (matched) {
      outRow["_SDAT_Owner"]   = sdatOwner;
      outRow["_SDAT_Address"] = sdatAddr;
      outRow["_Match_Type"]   = "Name + Address";
      matchRows.push(outRow);
    } else {
      outRow["_No_Match_Reason"] = reason;
      noMatchRows.push(outRow);
    }

    const pct = Math.round(((i+1)/total)*100);
    document.getElementById("progFill").style.width = pct + "%";
    document.getElementById("progText").innerHTML =
      `${pct}% &nbsp;¬∑&nbsp; <span style="color:#3fb950">${matchRows.length} matches</span> &nbsp;¬∑&nbsp; <span style="color:#f0883e">${noMatchRows.length} no match</span>`;

    await new Promise(r => setTimeout(r, 100));
  }

  document.getElementById("statTotal").textContent   = total.toLocaleString();
  document.getElementById("statMatches").textContent = matchRows.length.toLocaleString();
  document.getElementById("statNone").textContent    = noMatchRows.length.toLocaleString();
  document.getElementById("statRate").textContent    = total ? Math.round((matchRows.length/total)*100)+"%" : "0%";

  btnRun.disabled = false; btnRun.textContent = "‚ñ∂  Run Verification";
  document.getElementById("btnStop").classList.add("hidden");
  document.getElementById("resultsCard").classList.remove("hidden");
});

document.getElementById("btnStop").addEventListener("click", () => { aborted = true; });

// --- Download multi-tab xlsx using SheetJS ---
document.getElementById("btnDownload").addEventListener("click", () => {
  const origHeaders  = csvData.headers;
  const matchHeaders = [...origHeaders, "_SDAT_Owner", "_SDAT_Address", "_Match_Type"];
  const noMatchHeaders = [...origHeaders, "_No_Match_Reason"];

  function rowsToSheetData(headers, rows) {
    const data = [headers];
    rows.forEach(r => data.push(headers.map(h => r[h] || "")));
    return data;
  }

  const wb = XLSX.utils.book_new();

  // Tab 1: Verified Matches (green tab)
  const ws1 = XLSX.utils.aoa_to_sheet(rowsToSheetData(matchHeaders, matchRows));
  styleHeaderRow(ws1, matchHeaders.length, "1a3d22", "3fb950");
  XLSX.utils.book_append_sheet(wb, ws1, "Verified Matches");

  // Tab 2: No Match
  const ws2 = XLSX.utils.aoa_to_sheet(rowsToSheetData(noMatchHeaders, noMatchRows));
  styleHeaderRow(ws2, noMatchHeaders.length, "2d1f0e", "f0883e");
  XLSX.utils.book_append_sheet(wb, ws2, "No Match");

  const date = new Date().toISOString().slice(0,10);
  XLSX.writeFile(wb, `homeowner_verification_${date}.xlsx`);
});

function styleHeaderRow(ws, colCount, bgHex, fgHex) {
  for (let c = 0; c < colCount; c++) {
    const cell = XLSX.utils.encode_cell({ r: 0, c });
    if (!ws[cell]) continue;
    ws[cell].s = {
      font:    { bold: true, color: { rgb: fgHex } },
      fill:    { fgColor: { rgb: bgHex } },
      alignment: { horizontal: "center" }
    };
  }
}
</script>
</body>
</html>
